<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>íˆ¬ì ê¸°ë¡ íŠ¸ë˜ì»¤</title>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #0a0e1a;
    --surface: #111827;
    --surface2: #1a2235;
    --border: #1e2d45;
    --accent: #3b82f6;
    --accent2: #10b981;
    --accent3: #f59e0b;
    --danger: #ef4444;
    --text: #e2e8f0;
    --text2: #94a3b8;
    --text3: #4b6280;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: 'Noto Sans KR', sans-serif;
    min-height: 100vh;
    overflow-x: hidden;
  }

  /* ë°°ê²½ ê·¸ë¦¬ë“œ */
  body::before {
    content: '';
    position: fixed;
    inset: 0;
    background-image:
      linear-gradient(rgba(59,130,246,0.03) 1px, transparent 1px),
      linear-gradient(90deg, rgba(59,130,246,0.03) 1px, transparent 1px);
    background-size: 40px 40px;
    pointer-events: none;
    z-index: 0;
  }

  .container {
    max-width: 860px;
    margin: 0 auto;
    padding: 40px 20px;
    position: relative;
    z-index: 1;
  }

  /* í—¤ë” */
  header {
    margin-bottom: 40px;
  }

  .header-top {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-bottom: 6px;
  }

  .logo-dot {
    width: 10px; height: 10px;
    border-radius: 50%;
    background: var(--accent);
    box-shadow: 0 0 12px var(--accent);
    animation: pulse 2s infinite;
  }

  @keyframes pulse {
    0%, 100% { opacity: 1; transform: scale(1); }
    50% { opacity: 0.6; transform: scale(0.85); }
  }

  h1 {
    font-size: 22px;
    font-weight: 700;
    letter-spacing: -0.5px;
    color: var(--text);
  }

  .subtitle {
    font-size: 13px;
    color: var(--text3);
    font-weight: 300;
    margin-left: 22px;
  }

  /* íƒ­ */
  .tabs {
    display: flex;
    gap: 4px;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 4px;
    margin-bottom: 28px;
  }

  .tab {
    flex: 1;
    padding: 10px;
    border: none;
    background: transparent;
    color: var(--text2);
    border-radius: 9px;
    cursor: pointer;
    font-family: inherit;
    font-size: 13px;
    font-weight: 500;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 6px;
  }

  .tab.active {
    background: var(--surface2);
    color: var(--text);
    box-shadow: 0 2px 8px rgba(0,0,0,0.3);
  }

  .tab-icon { font-size: 15px; }

  /* ì¹´ë“œ */
  .card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 16px;
    padding: 24px;
    margin-bottom: 16px;
  }

  .card-title {
    font-size: 12px;
    font-weight: 500;
    color: var(--text3);
    text-transform: uppercase;
    letter-spacing: 1px;
    margin-bottom: 14px;
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .card-title::after {
    content: '';
    flex: 1;
    height: 1px;
    background: var(--border);
  }

  /* í…ìŠ¤íŠ¸ ì˜ì—­ */
  .paste-area {
    width: 100%;
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 14px 16px;
    color: var(--text);
    font-family: 'DM Mono', monospace;
    font-size: 12.5px;
    line-height: 1.7;
    resize: vertical;
    min-height: 130px;
    outline: none;
    transition: border-color 0.2s;
  }

  .paste-area:focus {
    border-color: var(--accent);
  }

  .paste-area::placeholder { color: var(--text3); }

  /* ë²„íŠ¼ */
  .btn-row {
    display: flex;
    gap: 10px;
    margin-top: 14px;
  }

  .btn {
    padding: 10px 20px;
    border-radius: 9px;
    border: none;
    font-family: inherit;
    font-size: 13px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    gap: 6px;
  }

  .btn-primary {
    background: var(--accent);
    color: white;
    flex: 1;
  }

  .btn-primary:hover { background: #2563eb; transform: translateY(-1px); }
  .btn-primary:active { transform: translateY(0); }

  .btn-ghost {
    background: var(--surface2);
    color: var(--text2);
    border: 1px solid var(--border);
  }

  .btn-ghost:hover { border-color: var(--text3); color: var(--text); }

  /* íŒŒì‹± ê²°ê³¼ */
  .result-box {
    display: none;
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 10px;
    overflow: hidden;
    margin-top: 16px;
  }

  .result-box.show { display: block; animation: fadeIn 0.3s ease; }

  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(6px); }
    to { opacity: 1; transform: translateY(0); }
  }

  .result-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 12px 16px;
    border-bottom: 1px solid var(--border);
  }

  .result-type {
    font-size: 11px;
    font-weight: 700;
    letter-spacing: 1px;
    text-transform: uppercase;
    padding: 3px 10px;
    border-radius: 20px;
  }

  .type-dividend { background: rgba(16,185,129,0.15); color: var(--accent2); }
  .type-buy { background: rgba(59,130,246,0.15); color: var(--accent); }
  .type-sell { background: rgba(239,68,68,0.15); color: var(--danger); }
  .type-unknown { background: rgba(148,163,184,0.15); color: var(--text2); }

  .result-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 0;
  }

  .result-item {
    padding: 12px 16px;
    border-bottom: 1px solid var(--border);
    border-right: 1px solid var(--border);
  }

  .result-item:nth-child(even) { border-right: none; }
  .result-item:nth-last-child(-n+2) { border-bottom: none; }

  .result-label {
    font-size: 11px;
    color: var(--text3);
    margin-bottom: 4px;
    font-weight: 500;
  }

  .result-value {
    font-size: 14px;
    color: var(--text);
    font-family: 'DM Mono', monospace;
    font-weight: 500;
  }

  .result-value.highlight { color: var(--accent2); }

  .result-edit {
    background: var(--bg);
    border: 1px solid var(--accent);
    border-radius: 6px;
    padding: 4px 8px;
    color: var(--text);
    font-family: 'DM Mono', monospace;
    font-size: 13px;
    width: 100%;
    outline: none;
  }
  .result-edit:focus { border-color: var(--accent2); }

  /* êµ¬ê¸€ ì‹œíŠ¸ ì„¤ì • */
  .input-group {
    display: flex;
    flex-direction: column;
    gap: 8px;
    margin-bottom: 14px;
  }

  .input-label {
    font-size: 12px;
    color: var(--text2);
    font-weight: 500;
  }

  .input-field {
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 9px;
    padding: 10px 14px;
    color: var(--text);
    font-family: 'DM Mono', monospace;
    font-size: 13px;
    outline: none;
    transition: border-color 0.2s;
    width: 100%;
  }

  .input-field:focus { border-color: var(--accent); }
  .input-field::placeholder { color: var(--text3); }

  /* ì—°ë™ ìƒíƒœ */
  .status-row {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 13px;
    color: var(--text2);
    margin-top: 12px;
  }

  .status-dot {
    width: 7px; height: 7px;
    border-radius: 50%;
    background: var(--text3);
  }

  .status-dot.connected { background: var(--accent2); box-shadow: 0 0 6px var(--accent2); }
  .status-dot.error { background: var(--danger); }

  /* ê¸°ë¡ ë¦¬ìŠ¤íŠ¸ */
  .records-list {
    display: flex;
    flex-direction: column;
    gap: 8px;
  }

  .record-item {
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 14px 16px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    animation: fadeIn 0.3s ease;
  }

  .record-left { display: flex; align-items: center; gap: 12px; }

  .record-badge {
    font-size: 10px;
    font-weight: 700;
    letter-spacing: 0.5px;
    padding: 3px 8px;
    border-radius: 6px;
    min-width: 48px;
    text-align: center;
  }

  .record-name { font-size: 14px; font-weight: 500; }
  .record-date { font-size: 11px; color: var(--text3); margin-top: 2px; font-family: 'DM Mono', monospace; }

  .record-amount {
    font-family: 'DM Mono', monospace;
    font-size: 14px;
    font-weight: 500;
    text-align: right;
  }

  .record-sub {
    font-size: 11px;
    color: var(--text3);
    margin-top: 2px;
    font-family: 'DM Mono', monospace;
  }

  /* ì•Œë¦¼ í† ìŠ¤íŠ¸ */
  .toast {
    position: fixed;
    bottom: 24px;
    left: 50%;
    transform: translateX(-50%) translateY(80px);
    background: var(--surface);
    border: 1px solid var(--border);
    color: var(--text);
    padding: 12px 20px;
    border-radius: 12px;
    font-size: 13px;
    display: flex;
    align-items: center;
    gap: 8px;
    box-shadow: 0 8px 32px rgba(0,0,0,0.4);
    z-index: 100;
    transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
    white-space: nowrap;
  }

  .toast.show { transform: translateX(-50%) translateY(0); }
  .toast.success { border-color: var(--accent2); }
  .toast.error { border-color: var(--danger); }

  /* ë„ì›€ë§ */
  .help-box {
    background: rgba(59,130,246,0.06);
    border: 1px solid rgba(59,130,246,0.2);
    border-radius: 10px;
    padding: 14px 16px;
    font-size: 12.5px;
    color: var(--text2);
    line-height: 1.7;
    margin-top: 14px;
  }

  .help-box strong { color: var(--accent); }

  .empty-state {
    text-align: center;
    padding: 40px 20px;
    color: var(--text3);
    font-size: 13px;
  }

  .empty-icon { font-size: 32px; margin-bottom: 10px; }

  /* êµ¬ê¸€ ì‹œíŠ¸ ê°€ì´ë“œ */
  .step-list {
    display: flex;
    flex-direction: column;
    gap: 12px;
    margin-top: 4px;
  }

  .step {
    display: flex;
    gap: 12px;
    align-items: flex-start;
  }

  .step-num {
    width: 22px; height: 22px;
    border-radius: 50%;
    background: rgba(59,130,246,0.15);
    color: var(--accent);
    font-size: 11px;
    font-weight: 700;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
    margin-top: 1px;
  }

  .step-text { font-size: 13px; color: var(--text2); line-height: 1.6; }
  .step-text code {
    background: var(--surface2);
    border: 1px solid var(--border);
    padding: 1px 6px;
    border-radius: 4px;
    font-family: 'DM Mono', monospace;
    font-size: 11.5px;
    color: var(--accent2);
  }

  .script-block {
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 14px 16px;
    margin-top: 10px;
    font-family: 'DM Mono', monospace;
    font-size: 11.5px;
    color: var(--accent2);
    line-height: 1.8;
    white-space: pre;
    overflow-x: auto;
    position: relative;
  }

  .copy-btn {
    position: absolute;
    top: 10px; right: 10px;
    background: var(--surface);
    border: 1px solid var(--border);
    color: var(--text2);
    padding: 4px 10px;
    border-radius: 6px;
    font-size: 11px;
    cursor: pointer;
    font-family: inherit;
    transition: all 0.2s;
  }

  .copy-btn:hover { border-color: var(--accent); color: var(--accent); }

  @media (max-width: 600px) {
    .result-grid { grid-template-columns: 1fr; }
    .result-item { border-right: none !important; }
    .result-item:nth-last-child(-n+2) { border-bottom: 1px solid var(--border); }
    .result-item:last-child { border-bottom: none; }
  }
</style>
</head>
<body>
<div class="container">
  <header>
    <div class="header-top">
      <div class="logo-dot"></div>
      <h1>íˆ¬ì ê¸°ë¡ íŠ¸ë˜ì»¤</h1>
    </div>
    <div class="subtitle">ì¹´ì¹´ì˜¤í†¡ ì•Œë¦¼ â†’ ìë™ íŒŒì‹± â†’ êµ¬ê¸€ ì‹œíŠ¸ ê¸°ë¡</div>
  </header>

  <div class="tabs">
    <button class="tab active" onclick="switchTab('parse')">
      <span class="tab-icon">ğŸ“‹</span> ë©”ì‹œì§€ íŒŒì‹±
    </button>
    <button class="tab" onclick="switchTab('bulk')">
      <span class="tab-icon">ğŸ“‚</span> ì¼ê´„ ê°€ì ¸ì˜¤ê¸°
    </button>
    <button class="tab" onclick="switchTab('records')">
      <span class="tab-icon">ğŸ“Š</span> ê¸°ë¡ <span id="record-count" style="background:rgba(59,130,246,0.2);color:var(--accent);padding:1px 7px;border-radius:10px;font-size:11px;margin-left:2px">0</span>
    </button>
    <button class="tab" onclick="switchTab('settings')">
      <span class="tab-icon">âš™ï¸</span> êµ¬ê¸€ ì‹œíŠ¸ ì—°ë™
    </button>
  </div>

  <!-- íŒŒì‹± íƒ­ -->
  <div id="tab-parse">
    <div class="card">
      <div class="card-title">ì¹´ì¹´ì˜¤í†¡ ë©”ì‹œì§€ ë¶™ì—¬ë„£ê¸°</div>
      <textarea class="paste-area" id="msg-input" placeholder="ì¹´ì¹´ì˜¤í†¡ ë‚ ì§œ í—¤ë”ì™€ ë©”ì‹œì§€ë¥¼ í•¨ê»˜ ë¶™ì—¬ë„£ìœ¼ë©´ ë‚ ì§œê°€ ìë™ ì¸ì‹ë©ë‹ˆë‹¤.

ì˜ˆì‹œ:
2026ë…„ 2ì›” 24ì¼ ì˜¤ì „ 8:02, ì‚¼ì„±ì¦ê¶Œ :
[ì‚¼ì„±ì¦ê¶Œ] &lt;ë°°ë‹¹ê¸ˆ ì…ê¸ˆ ì•ˆë‚´&gt;
-ì¢…ëª©ëª… : ë§¥ì¿¼ë¦¬ì¸í”„ë¼
-ì„¸í›„ ë°°ë‹¹ê¸ˆì•¡ : 100,320ì›
...

â€» ë‚ ì§œ í—¤ë” ì—†ì´ ë¶™ì—¬ë„£ìœ¼ë©´ ì˜¤ëŠ˜ ë‚ ì§œë¡œ ìë™ì…ë ¥ë©ë‹ˆë‹¤ (ìˆ˜ì • ê°€ëŠ¥)"></textarea>
      <div class="btn-row">
        <button class="btn btn-primary" onclick="parseMessage()">
          âš¡ ìë™ íŒŒì‹±
        </button>
        <button class="btn btn-ghost" onclick="clearInput()">ì§€ìš°ê¸°</button>
      </div>
    </div>

    <div class="result-box" id="result-box">
      <div class="result-header">
        <span id="result-type-badge" class="result-type"></span>
        <span style="font-size:12px;color:var(--text3)" id="result-source"></span>
      </div>
      <div class="result-grid" id="result-grid"></div>
      <div style="padding:12px 16px;border-top:1px solid var(--border)">
        <div class="btn-row">
          <button class="btn btn-primary" onclick="saveRecord()" id="save-btn">
            ğŸ’¾ ê¸°ë¡ ì €ì¥
          </button>
          <button class="btn btn-ghost" id="sheets-btn" onclick="sendToSheets()" style="display:none">
            ğŸ“¤ êµ¬ê¸€ ì‹œíŠ¸ ì „ì†¡
          </button>
        </div>
      </div>
    </div>

    <div class="help-box">
      <strong>ì§€ì› ë©”ì‹œì§€ í˜•ì‹</strong><br>
      ì‚¼ì„±ì¦ê¶Œ ë°°ë‹¹ê¸ˆ ì…ê¸ˆ ì•ˆë‚´ Â· ë§¤ìˆ˜/ë§¤ë„ ì²´ê²° ì•Œë¦¼<br>
      í‚¤ì›€ì¦ê¶Œ, NHíˆ¬ìì¦ê¶Œ, ë¯¸ë˜ì—ì…‹ ë“± ë‹¤ë¥¸ ì¦ê¶Œì‚¬ë„ ë©”ì‹œì§€ë¥¼ ë¶™ì—¬ë„£ìœ¼ë©´ ìë™ ì¸ì‹í•©ë‹ˆë‹¤.
    </div>
  </div>

  <!-- ì¼ê´„ ê°€ì ¸ì˜¤ê¸° íƒ­ -->
  <div id="tab-bulk" style="display:none">
    <div class="card">
      <div class="card-title">ì¹´ì¹´ì˜¤í†¡ ëŒ€í™” txt íŒŒì¼ ì—…ë¡œë“œ</div>
      <div id="drop-zone" style="
        border: 2px dashed var(--border);
        border-radius: 12px;
        padding: 36px 20px;
        text-align: center;
        cursor: pointer;
        transition: all 0.2s;
        color: var(--text3);
      " onclick="document.getElementById('file-input').click()"
         ondragover="event.preventDefault();this.style.borderColor='var(--accent)'"
         ondragleave="this.style.borderColor='var(--border)'"
         ondrop="handleDrop(event)">
        <div style="font-size:36px;margin-bottom:10px">ğŸ“‚</div>
        <div style="font-size:14px;margin-bottom:6px;color:var(--text2)">txt íŒŒì¼ì„ ë“œë˜ê·¸í•˜ê±°ë‚˜ í´ë¦­í•´ì„œ ì—…ë¡œë“œ</div>
        <div style="font-size:12px">ì¹´ì¹´ì˜¤í†¡ â†’ ëŒ€í™”ë°© â†’ ë©”ë‰´ â†’ ëŒ€í™” ë‚´ë³´ë‚´ê¸° â†’ txt</div>
      </div>
      <input type="file" id="file-input" accept=".txt" style="display:none" onchange="handleFileSelect(event)">
    </div>

    <div class="card" id="bulk-preview" style="display:none">
      <div class="card-title">íŒŒì‹± ê²°ê³¼ ë¯¸ë¦¬ë³´ê¸°</div>
      <div id="bulk-stats" style="display:flex;gap:16px;margin-bottom:16px;flex-wrap:wrap"></div>
      <div id="bulk-list" style="max-height:360px;overflow-y:auto;display:flex;flex-direction:column;gap:6px"></div>
      <div class="btn-row" style="margin-top:16px">
        <button class="btn btn-primary" onclick="bulkSendAll()" id="bulk-send-btn">
          ğŸ“¤ ì „ì²´ êµ¬ê¸€ ì‹œíŠ¸ ì „ì†¡
        </button>
        <button class="btn btn-ghost" onclick="bulkSaveLocal()" >
          ğŸ’¾ ë¡œì»¬ ì €ì¥ë§Œ
        </button>
      </div>
      <div id="bulk-progress" style="display:none;margin-top:12px">
        <div style="background:var(--surface2);border-radius:6px;height:6px;overflow:hidden">
          <div id="progress-bar" style="height:100%;background:var(--accent);width:0%;transition:width 0.3s"></div>
        </div>
        <div id="progress-text" style="font-size:12px;color:var(--text3);margin-top:6px;text-align:center"></div>
      </div>
    </div>
  </div>

  <!-- ê¸°ë¡ íƒ­ -->
  <div id="tab-records" style="display:none">
    <div class="card">
      <div class="card-title">íˆ¬ì ê¸°ë¡</div>
      <div id="records-container">
        <div class="empty-state">
          <div class="empty-icon">ğŸ“­</div>
          ì•„ì§ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.<br>ë©”ì‹œì§€ë¥¼ íŒŒì‹±í•˜ê³  ì €ì¥í•´ë³´ì„¸ìš”.
        </div>
      </div>
    </div>
  </div>

  <!-- ì„¤ì • íƒ­ -->
  <div id="tab-settings" style="display:none">
    <div class="card">
      <div class="card-title">êµ¬ê¸€ ì‹œíŠ¸ ì—°ë™ ì„¤ì •</div>

      <div class="input-group">
        <div class="input-label">ì›¹ì•± URL (Google Apps Script ë°°í¬ URL)</div>
        <input class="input-field" id="sheets-url" type="text"
          placeholder="https://script.google.com/macros/s/XXXXX/exec"
          oninput="saveSettings()">
      </div>
      <div class="help-box" style="margin-top:0;margin-bottom:14px">
        ğŸ’¡ <strong>ë§¤ë²ˆ ì…ë ¥í•˜ê¸° ê·€ì°®ë‹¤ë©´</strong> â€” ì•„ë˜ ë²„íŠ¼ìœ¼ë¡œ URLì„ íŒŒì¼ ì•ˆì— ì˜êµ¬ ì €ì¥í•˜ì„¸ìš”.<br>
        í•œ ë²ˆë§Œ ì„¤ì •í•˜ë©´ íŒŒì¼ì„ ì—´ ë•Œë§ˆë‹¤ ìë™ìœ¼ë¡œ ì—°ê²°ë©ë‹ˆë‹¤.
        <button class="btn btn-primary" style="margin-top:10px;width:100%" onclick="embedUrl()">
          ğŸ”’ URLì„ íŒŒì¼ì— ì˜êµ¬ ì €ì¥í•˜ê¸°
        </button>
      </div>

      <div class="status-row">
        <div class="status-dot" id="status-dot"></div>
        <span id="status-text">URLì„ ì…ë ¥í•˜ë©´ ì—°ë™ì´ í™œì„±í™”ë©ë‹ˆë‹¤</span>
      </div>

      <div style="display:flex;gap:8px;margin-top:14px">
        <button class="btn btn-ghost" style="flex:1" onclick="openUrlTest()">
          ğŸ”— URL ë¸Œë¼ìš°ì €ì—ì„œ ì—´ì–´ì„œ í™•ì¸
        </button>
        <button class="btn btn-primary" style="flex:1" onclick="markConnected()">
          âœ… ì—°ê²°ëì–´ìš” (ìˆ˜ë™ í™•ì¸)
        </button>
      </div>
      <div class="help-box" style="margin-top:10px">
        <strong>í™•ì¸ ë°©ë²•</strong><br>
        1. ìœ„ ë²„íŠ¼ìœ¼ë¡œ URLì„ ë¸Œë¼ìš°ì €ì—ì„œ ì—´ì–´ë³´ì„¸ìš”<br>
        2. í™”ë©´ì— <code style="background:var(--surface);padding:1px 5px;border-radius:3px;font-family:monospace">{"result":"ok"}</code> ê°€ ë³´ì´ë©´ ì •ìƒì…ë‹ˆë‹¤<br>
        3. ì •ìƒì´ë©´ ì˜¤ë¥¸ìª½ "ì—°ê²°ëì–´ìš”" ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”
      </div>
    </div>

    <div class="card">
      <div class="card-title">Google Apps Script ì„¤ì • ë°©ë²•</div>
      <div class="step-list">
        <div class="step">
          <div class="step-num">1</div>
          <div class="step-text">êµ¬ê¸€ ë“œë¼ì´ë¸Œì—ì„œ <strong style="color:var(--text)">ìŠ¤í”„ë ˆë“œì‹œíŠ¸</strong>ë¥¼ ìƒˆë¡œ ë§Œë“œì„¸ìš”.<br>
          ì‹œíŠ¸ ì´ë¦„ì„ <code>íˆ¬ìê¸°ë¡</code>ìœ¼ë¡œ ë³€ê²½í•˜ì„¸ìš”.</div>
        </div>
        <div class="step">
          <div class="step-num">2</div>
          <div class="step-text">ìƒë‹¨ ë©”ë‰´ <code>í™•ì¥ í”„ë¡œê·¸ë¨</code> â†’ <code>Apps Script</code> í´ë¦­</div>
        </div>
        <div class="step">
          <div class="step-num">3</div>
          <div class="step-text">ì•„ë˜ ìŠ¤í¬ë¦½íŠ¸ë¥¼ ë³µì‚¬í•´ì„œ ë¶™ì—¬ë„£ê³  ì €ì¥í•˜ì„¸ìš” (<code>Ctrl+S</code>)</div>
        </div>
        <div class="step">
          <div class="step-num">4</div>
          <div class="step-text"><code>ë°°í¬</code> â†’ <code>ìƒˆ ë°°í¬</code> â†’ ìœ í˜•: <code>ì›¹ ì•±</code> â†’ ì•¡ì„¸ìŠ¤: <code>ëª¨ë“  ì‚¬ìš©ì</code> â†’ ë°°í¬</div>
        </div>
        <div class="step">
          <div class="step-num">5</div>
          <div class="step-text">ìƒì„±ëœ <strong style="color:var(--text)">ì›¹ ì•± URL</strong>ì„ ìœ„ ì…ë ¥ì°½ì— ë¶™ì—¬ë„£ìœ¼ì„¸ìš”</div>
        </div>
      </div>

      <div class="script-block" id="script-code">function doGet(e) {
  try {
    var p = e && e.parameter ? e.parameter : {};

    // ì—°ê²° í…ŒìŠ¤íŠ¸
    if (p.test && !p.name) {
      return response({result: 'ok', message: 'ì—°ê²° ì„±ê³µ!'});
    }

    var ss = SpreadsheetApp.getActiveSpreadsheet();
    var sheet = ss.getSheetByName('íˆ¬ìê¸°ë¡');
    if (!sheet) {
      ss.getActiveSheet().setName('íˆ¬ìê¸°ë¡');
      sheet = ss.getActiveSheet();
    }

    // í—¤ë” ìë™ ìƒì„±
    if (sheet.getLastRow() === 0) {
      sheet.appendRow([
        'ë‚ ì§œ','ì¢…ë¥˜','êµ­ë‚´/í•´ì™¸','ì¦ê¶Œì‚¬','ì¢…ëª©ëª…',
        'ê¸ˆì•¡(ì›)','ê¸ˆì•¡(USD)','ìˆ˜ëŸ‰','ë‹¨ê°€','ê³„ì¢Œë²ˆí˜¸','ê¸°ë¡ì¼ì‹œ'
      ]);
    }

    // ìˆ«ì ë³€í™˜ í—¬í¼ (ì½¤ë§ˆ ì œê±° í›„ ìˆ«ìë¡œ)
    function toNum(v) {
      if (!v) return '';
      var n = parseFloat(String(v).replace(/,/g, ''));
      return isNaN(n) ? '' : n;
    }

    var row = [
      p.date             || '',
      p.type             || '',
      p.market           || '',
      p.broker           || '',
      p.name             || '',
      toNum(p.amountKRW),
      toNum(p.amountUSD),
      toNum(p.quantity),
      toNum(p.price),
      p.account          || '',
      Utilities.formatDate(new Date(), 'Asia/Seoul', 'yyyy.MM.dd HH:mm:ss')
    ];

    sheet.appendRow(row);

    // ê¸ˆì•¡(ì›) Fì—´, ê¸ˆì•¡(USD) Gì—´ ì„œì‹ ì ìš©
    var lastRow = sheet.getLastRow();
    if (p.amountKRW) {
      sheet.getRange(lastRow, 6).setNumberFormat('#,##0');
    }
    if (p.amountUSD) {
      sheet.getRange(lastRow, 7).setNumberFormat('#,##0.0000');
    }
    if (p.quantity) {
      sheet.getRange(lastRow, 8).setNumberFormat('#,##0');
    }
    if (p.price) {
      sheet.getRange(lastRow, 9).setNumberFormat('#,##0');
    }

    SpreadsheetApp.flush(); // ì¦‰ì‹œ ì €ì¥ ê°•ì œ

    return response({result: 'success', rows: sheet.getLastRow()});

  } catch(err) {
    return response({result: 'error', message: err.toString()});
  }
}

function response(obj) {
  return ContentService
    .createTextOutput(JSON.stringify(obj))
    .setMimeType(ContentService.MimeType.JSON);
}</div>
      <button class="copy-btn" onclick="copyScript()">ë³µì‚¬</button>
    </div>
  </div>

</div>

<div class="toast" id="toast"></div>

<script>
// â”€â”€â”€ ìƒíƒœ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let records = JSON.parse(localStorage.getItem('inv_records') || '[]');
let currentParsed = null;
// â˜… ì—¬ê¸°ì— êµ¬ê¸€ Apps Script URLì„ ë¶™ì—¬ë„£ìœ¼ë©´ ë§¤ë²ˆ ì…ë ¥ ë¶ˆí•„ìš”
const FIXED_SHEETS_URL = '';  // ì˜ˆ: 'https://script.google.com/macros/s/XXXX/exec'

let sheetsUrl = FIXED_SHEETS_URL || localStorage.getItem('inv_sheets_url') || '';

// ì´ˆê¸°í™”
window.onload = () => {
  if (sheetsUrl) {
    document.getElementById('sheets-url').value = sheetsUrl;
    updateStatus(true);
  }
  renderRecords();
  updateCount();
};

// â”€â”€â”€ íƒ­ ì „í™˜ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function switchTab(name) {
  ['parse','bulk','records','settings'].forEach(t => {
    document.getElementById('tab-'+t).style.display = t === name ? 'block' : 'none';
  });
  document.querySelectorAll('.tab').forEach((el, i) => {
    el.classList.toggle('active', ['parse','bulk','records','settings'][i] === name);
  });
}

// â”€â”€â”€ íŒŒì‹± â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function parseMessage() {
  const msg = document.getElementById('msg-input').value.trim();
  if (!msg) { showToast('â— ë©”ì‹œì§€ë¥¼ ë¨¼ì € ë¶™ì—¬ë„£ì–´ ì£¼ì„¸ìš”', 'error'); return; }

  const result = extractData(msg);
  currentParsed = result;
  showResult(result);
}

function extractData(msg) {
  const data = { raw: msg, type: 'unknown', broker: '', name: '', date: '',
    amount: '', quantity: '', price: '', account: '', taxBefore: '', tax: '' };

  // ì¦ê¶Œì‚¬ ê°ì§€ (ëŒ€ê´„í˜¸ í˜•ì‹ + ì¤„ë°”ê¿ˆ í˜•ì‹ ëª¨ë‘ ì§€ì›)
  const brokerMatch = msg.match(/\[([\wê°€-í£]+ì¦ê¶Œ|[\wê°€-í£]+íˆ¬ì|í‚¤ì›€|ë¯¸ë˜ì—ì…‹|í•œíˆ¬|KBì¦ê¶Œ|KB|NH|ì‹ í•œ|ëŒ€ì‹ |í•˜ë‚˜|í•˜ì´|í† ìŠ¤|LS|IBK[\wê°€-í£]*)\]/i)
    || msg.match(/^\[(í•œêµ­íˆ¬ì|ì‚¼ì„±ì¦ê¶Œ|í‚¤ì›€ì¦ê¶Œ|NHíˆ¬ì|ë¯¸ë˜ì—ì…‹|ì‹ í•œíˆ¬ì|KBì¦ê¶Œ|ëŒ€ì‹ ì¦ê¶Œ|í•˜ë‚˜ì¦ê¶Œ|í† ìŠ¤ì¦ê¶Œ|IBKê¸°ì—…ì€í–‰)\]/m);
  if (brokerMatch) data.broker = brokerMatch[1];
  if (!data.broker && msg.match(/^\[í•œêµ­íˆ¬ì\]/m)) data.broker = 'í•œêµ­íˆ¬ìì¦ê¶Œ';
  if (!data.broker && msg.match(/^\[í‚¤ì›€\]/m)) data.broker = 'í‚¤ì›€ì¦ê¶Œ';
  if (!data.broker && msg.includes('IBKê¸°ì—…ì€í–‰')) data.broker = 'IBKê¸°ì—…ì€í–‰';

  // íƒ€ì… ê°ì§€
  // ë°°ë‹¹/ë¶„ë°°ê¸ˆ â€” ë‹¤ì–‘í•œ ìš©ì–´ í†µí•©
  const isDividend = msg.includes('ë°°ë‹¹ê¸ˆ') || msg.includes('ë¶„ë°°ê¸ˆ') ||
    msg.includes('ETF ë¶„ë°°ê¸ˆ') || msg.includes('ê²°ì‚°ë¶„ë°°ê¸ˆ') ||
    msg.includes('ë°°ë‹¹(í˜„ê¸ˆ)');
  // ë§¤ìˆ˜/ë§¤ë„ ì²´ê²°
  const isBuy = /ì£¼ë¬¸ìœ í˜•\s*:\s*ë§¤ìˆ˜/.test(msg) ||
    msg.includes('í•´ì™¸ì£¼ì‹ ë§¤ìˆ˜ ì£¼ë¬¸ì´ ì²´ê²°') ||
    (msg.includes('ë§¤ìˆ˜') && msg.includes('ì²´ê²°'));
  const isSell = /ì£¼ë¬¸ìœ í˜•\s*:\s*ë§¤ë„/.test(msg) ||
    msg.includes('í•´ì™¸ì£¼ì‹ ë§¤ë„ ì£¼ë¬¸ì´ ì²´ê²°') ||
    (msg.includes('ë§¤ë„') && msg.includes('ì²´ê²°'));

  if (isDividend) data.type = 'ë°°ë‹¹ê¸ˆ';
  else if (isBuy)  data.type = 'ë§¤ìˆ˜';
  else if (isSell) data.type = 'ë§¤ë„';

  // ì¢…ëª©ëª… (* ë˜ëŠ” - ê¸€ë¨¸ë¦¬ ëª¨ë‘ ì§€ì›)
  const namePatterns = [
    /ì¢…\s*ëª©\s*ëª…\s*:\s*([^\n\râ˜…âˆ¨â– ã…‡â–¶]+)/,
    /ìƒ\s*í’ˆ\s*ëª…\s*:\s*([^\n\râ˜…âˆ¨â– ã…‡â–¶]+)/,
    /ì¢…ëª©ëª…\s*:\s*([^\n\râ˜…âˆ¨â– ã…‡â–¶]+)/,
    /ì¢…ëª©\s*:\s*([^\n\râ˜…âˆ¨â– ã…‡â–¶]+)/,
    /ìƒí’ˆëª…\s*:\s*([^\n\râ˜…âˆ¨â– ã…‡â–¶]+)/,
  ];
  for (const p of namePatterns) {
    const m = msg.match(p);
    if (m) { data.name = m[1].trim(); break; }
  }

  // ì¢…ëª©ì½”ë“œ ì¶”ì¶œ (ì‚¼ì„±ì¦ê¶Œ í•´ì™¸ì£¼ì‹ ë§¤ë§¤: - ì¢…ëª©ì½”ë“œ : SCHD)
  const tickerMatch = msg.match(/ì¢…ëª©ì½”ë“œ\s*:\s*([A-Z0-9]+)/);
  if (tickerMatch) {
    data.ticker = tickerMatch[1].trim();
    // í•´ì™¸ì£¼ì‹ì´ê³  ì¢…ëª©ì½”ë“œê°€ ìˆìœ¼ë©´ ì¢…ëª©ëª… ëŒ€ì‹  ì‚¬ìš©
    data.name = data.ticker;
  }

  // ê³„ì¢Œë²ˆí˜¸
  const accPatterns = [
    /ê³„ì¢Œë²ˆí˜¸\s*:\s*([\d\*\-]+)/,
    /ê³„ì¢Œë²ˆí˜¸\s*:\s*([^\s\[]+)/,    // KB: ***-***-*69 [01] ì—ì„œ [01] ì „ê¹Œì§€
    /ê³„ì¢Œ\s*:\s*([\d\*\-]+)/,
  ];
  // IBK URL ì œê±° (íŒŒì‹± ì˜¤ì—¼ ë°©ì§€)
  const cleanMsg = msg.replace(/http[^\s]*/g, '').replace(/__+/g, '');
  for (const p of accPatterns) {
    const m = msg.match(p);
    if (m) { data.account = m[1].trim(); break; }
  }

  // ë‚ ì§œ
  // ë‚ ì§œ íŒŒì‹± ìš°ì„ ìˆœìœ„:
  // 1) ì…ê¸ˆì¼ì/ì²˜ë¦¬ì¼ì/ì²´ê²°ì¼ì ë“± ë©”ì‹œì§€ ë‚´ ëª…ì‹œëœ ë‚ ì§œ
  // 2) ì¹´ì¹´ì˜¤í†¡ í—¤ë” ë‚ ì§œ ("2026ë…„ 2ì›” 24ì¼ ì˜¤ì „ 8:02" í˜•ì‹)
  // 3) ì˜¤ëŠ˜ ë‚ ì§œ (ìë™ì…ë ¥, ìˆ˜ì • ê°€ëŠ¥)
  const inputDateMatch = msg.match(/ì…ê¸ˆì¼ì\s*:\s*([\dë…„ì›”ì¼\s]+)/)
    || msg.match(/ì²˜ë¦¬ì¼ì\s*:\s*([\d\/\-ë…„ì›”ì¼]+)/)
    || msg.match(/ì²´ê²°ì¼ì?\s*:\s*([\dë…„ì›”ì¼\s\-\.\/]+)/);

  // ì¹´ì¹´ì˜¤í†¡ í—¤ë” ë‚ ì§œ: "2026ë…„ 2ì›” 24ì¼ ì˜¤ì „ 8:02, ì‚¼ì„±ì¦ê¶Œ :"
  const kakaoHeaderMatch = msg.match(/^(\d{4}ë…„\s*\d{1,2}ì›”\s*\d{1,2}ì¼)\s*(?:ì˜¤ì „|ì˜¤í›„)\s*\d{1,2}:\d{2},/);

  if (inputDateMatch) {
    data.date = inputDateMatch[1].trim();
    data.dateAuto = false;
  } else if (kakaoHeaderMatch) {
    data.date = kakaoHeaderMatch[1].trim();
    data.dateAuto = false;
  } else {
    const today = new Date();
    data.date = `${today.getFullYear()}ë…„ ${today.getMonth()+1}ì›” ${today.getDate()}ì¼`;
    data.dateAuto = true;
  }

  // ê¸ˆì•¡ íŒŒì‹±
  const amtPatterns = [
    { key: 'amount', patterns: [
      /ë°°ë‹¹ê¸ˆ\s*:\s*([\d.]+[(ï¼ˆ][A-Z]+[)ï¼‰])/,       // ì‚¼ì„± í•´ì™¸: 0.88(USD)
      /ë°°ë‹¹ê¸ˆì•¡?\s*:\s*([A-Z]+\s*[\d.]+)/,           // KB í•´ì™¸: USD 0.09
      /ê²°ì œê¸ˆì•¡\(ëˆ„ì \)\s*:\s*([\d.]+)/,              // ì‚¼ì„± í•´ì™¸ë§¤ë§¤: 61.860
      /ì„¸í›„ë°°ë‹¹ê¸ˆ[^:]*:\s*([\d,]+ì›?)/,              // KB: ì„¸í›„ë°°ë‹¹ê¸ˆ(ì‹¤ì…ê¸ˆì•¡)
      /ì„¸í›„\s*ë°°ë‹¹ê¸ˆì•¡?\s*:\s*([\d,]+ì›?)/,
      /ì„¸í›„\s*ë¶„ë°°ê¸ˆì•¡\s*:\s*([\d,]+ì›?)/,
      /ì„¸í›„\s*ë¶„ë°°ê¸ˆ\s*:\s*([\d,]+ì›?)/,       // ë¶„ë°°ê¸ˆ ì¶”ê°€ íŒ¨í„´
      /ë°°ë‹¹ì…ê¸ˆ\s*:.*?\/(.*?)\s*[(ï¼ˆ]ì„¸í›„[)ï¼‰]/,      // í‚¤ì›€: ì„¸ì „/ì„¸í›„ í˜•ì‹
      /ë°°ë‹¹ê¸ˆì•¡?\s*:\s*([\d,]+ì›?)/,
      /ë°°ë‹¹ê¸ˆ\s*:\s*([\d.]+)/,
      /ì…ê¸ˆê¸ˆì•¡\s*:\s*([\d,]+ì›?)/,
      /ì…ê¸ˆì•¡\s*:\s*([\d,]+ì›?)/,
      /ì…ê¸ˆ\s*ê¸ˆì•¡\s*:\s*([\d,]+ì›?)/,
      /ì²´ê²°ê¸ˆì•¡\s*:\s*([\d,]+ì›?)/,
      /ê±°ë˜ê¸ˆì•¡\s*:\s*([\d,]+ì›?)/,
    ]},
    { key: 'taxBefore', patterns: [
      /ì„¸ì „ë°°ë‹¹ê¸ˆ\s*:\s*([\d,]+ì›?)/,               // KB: ì„¸ì „ë°°ë‹¹ê¸ˆ: 380ì›
      /ì„¸ì „\s*ë°°ë‹¹ê¸ˆì•¡?\s*:\s*([\d,]+ì›?)/,
      /ë°°ë‹¹ì…ê¸ˆ\s*:\s*([\d,]+)\s*[(ï¼ˆ]ì„¸ì „[)ï¼‰]/,    // í‚¤ì›€: 15,960 (ì„¸ì „)
    ]},
    { key: 'tax', patterns: [/ì„¸ê¸ˆ\s*:\s*([\d,]+ì›?)/] },
    { key: 'quantity', patterns: [
      /ì²´ê²°ìˆ˜ëŸ‰\s*:\s*([\d,]+ì£¼?)/,
      /ì£¼ë¬¸ìˆ˜ëŸ‰\s*:\s*([\d,]+ì£¼?)/,   // ì‚¼ì„± í•´ì™¸ë§¤ë§¤
      /ë§¤ë§¤ìˆ˜ëŸ‰\s*:\s*([\d,]+ì£¼?)/,   // IBK
      /ìˆ˜ëŸ‰\s*:\s*([\d,]+ì£¼?)/,
    ]},
    { key: 'price', patterns: [
      /ì²´ê²°ê°€ê²©\s*:\s*([\d,.]+)/,     // ì‚¼ì„± í•´ì™¸ë§¤ë§¤: USD ì†Œìˆ˜ì 
      /ë§¤ë§¤ë‹¨ê°€\s*:\s*([\d,]+ì›?)/,   // IBK
      /ì²´ê²°ë‹¨ê°€\s*:\s*([\d,]+ì›?)/,
      /ë‹¨ê°€\s*:\s*([\d,]+ì›?)/,
    ]},
  ];

  for (const { key, patterns } of amtPatterns) {
    for (const p of patterns) {
      const m = msg.match(p);
      if (m) { data[key] = m[1].trim(); break; }
    }
  }

  // â”€â”€ í†µí™”/ì‹œì¥ ê°ì§€ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const isUSD = (/USD|ë‹¬ëŸ¬/.test(msg)) ||
    (msg.includes('í•´ì™¸ì£¼ì‹') && !msg.includes('ì„¸í›„ë°°ë‹¹ê¸ˆ') && !msg.includes('ì„¸í›„ ë°°ë‹¹ê¸ˆ'));
  const marketMatch = msg.match(/ê±°ë˜ì‹œì¥\s*:\s*([^\n\râ– ]+)/);

  data.currency = isUSD ? 'USD' : 'KRW';
  data.market   = isUSD ? (marketMatch ? marketMatch[1].trim() : 'í•´ì™¸') : 'êµ­ë‚´';

  // â”€â”€ ê¸ˆì•¡ ë¶„ë¦¬ (ì›í™” vs USD) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const rawAmt = data.amount || '';
  if (data.currency === 'USD') {
    // USD ìˆ«ìë§Œ ì¶”ì¶œ
    const usdMatch = rawAmt.match(/([\d.]+)/);
    data.amountUSD = usdMatch ? usdMatch[1] : rawAmt;
    data.amountKRW = '';
  } else {
    // ì›í™” ìˆ«ìë§Œ ì¶”ì¶œ (ì½¤ë§ˆ/ì› ì œê±°)
    const krwMatch = rawAmt.match(/([\d,]+)/);
    data.amountKRW = krwMatch ? krwMatch[1].replace(/,/g,'') : rawAmt;
    data.amountUSD = '';
  }

  // â”€â”€ ë‹¨ê°€ ìˆ«ìë§Œ ì¶”ì¶œ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  if (data.price) {
    const priceMatch = data.price.match(/([\d,]+)/);
    data.price = priceMatch ? priceMatch[1].replace(/,/g,'') : data.price;
  }

  // â”€â”€ ìˆ˜ëŸ‰ ìˆ«ìë§Œ ì¶”ì¶œ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  if (data.quantity) {
    const qtyMatch = data.quantity.match(/([\d,]+)/);
    data.quantity = qtyMatch ? qtyMatch[1].replace(/,/g,'') : data.quantity;
  }

  // â”€â”€ ë‚ ì§œ ì •ê·œí™” â†’ YYYY-MM-DD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  if (data.date) {
    let d = data.date.trim();
    // 2026ë…„ 02ì›” 27ì¼ or 2026ë…„2ì›”27ì¼
    d = d.replace(/(\d{4})ë…„\s*(\d{1,2})ì›”\s*(\d{1,2})ì¼?/, (_, y, m, day) =>
      `${y}-${m.padStart(2,'0')}-${day.padStart(2,'0')}`);
    // 2026/02/19
    d = d.replace(/(\d{4})\/(\d{1,2})\/(\d{1,2})/, (_, y, m, day) =>
      `${y}-${m.padStart(2,'0')}-${day.padStart(2,'0')}`);
    // 02/27 (ì—°ë„ ì—†ëŠ” ê²½ìš° ì˜¬í•´ë¡œ)
    d = d.replace(/^(\d{2})\/(\d{2})$/, (_, m, day) =>
      `${new Date().getFullYear()}-${m}-${day}`);
    data.date = d;
  }

  return data;
}

// â”€â”€â”€ ê²°ê³¼ í‘œì‹œ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showResult(data) {
  const box = document.getElementById('result-box');
  const badge = document.getElementById('result-type-badge');
  const grid = document.getElementById('result-grid');

  const typeMap = {
    'ë°°ë‹¹ê¸ˆ': { label: 'ë°°ë‹¹ê¸ˆ', cls: 'type-dividend' },
    'ë§¤ìˆ˜': { label: 'ë§¤ìˆ˜', cls: 'type-buy' },
    'ë§¤ë„': { label: 'ë§¤ë„', cls: 'type-sell' },
    unknown: { label: 'ì•Œ ìˆ˜ ì—†ìŒ', cls: 'type-unknown' },
  };

  const t = typeMap[data.type];
  badge.textContent = t.label;
  badge.className = 'result-type ' + t.cls;

  document.getElementById('result-source').textContent = data.broker || 'ì¦ê¶Œì‚¬ ë¯¸í™•ì¸';

  // í‘œì‹œí•  í•„ë“œ êµ¬ì„±
  let fields = [];
  if (data.name) fields.push({ label: 'ì¢…ëª©ëª…', value: data.name });
  fields.push({ label: 'ì…ê¸ˆì¼' + (data.dateAuto ? ' (ìë™ì…ë ¥ â€” ìˆ˜ì • ê°€ëŠ¥)' : ''), value: data.date, editable: true, key: 'date' });
  if (data.amountKRW) fields.push({ label: 'ê¸ˆì•¡ (ì›)', value: Number(data.amountKRW).toLocaleString() + 'ì›', hl: true });
  if (data.amountUSD) fields.push({ label: 'ê¸ˆì•¡ (USD)', value: 'USD ' + data.amountUSD, hl: true });
  if (data.taxBefore) fields.push({ label: 'ì„¸ì „ ê¸ˆì•¡', value: data.taxBefore });
  fields.push({ label: 'êµ­ë‚´/í•´ì™¸', value: data.market || 'êµ­ë‚´' });
  if (data.tax) fields.push({ label: 'ì„¸ê¸ˆ', value: data.tax });
  if (data.quantity) fields.push({ label: 'ìˆ˜ëŸ‰', value: data.quantity });
  if (data.price) fields.push({ label: 'ë‹¨ê°€', value: data.price });
  if (data.account) fields.push({ label: 'ê³„ì¢Œë²ˆí˜¸', value: data.account });

  if (fields.length % 2 !== 0) fields.push({ label: '', value: '' });

  grid.innerHTML = fields.map(f => `
    <div class="result-item">
      <div class="result-label">${f.label}</div>
      ${f.editable
        ? `<input class="result-edit" value="${f.value || ''}" oninput="currentParsed['${f.key}']=this.value" />`
        : `<div class="result-value ${f.hl ? 'highlight' : ''}">${f.value || '-'}</div>`
      }
    </div>
  `).join('');

  // êµ¬ê¸€ ì‹œíŠ¸ ë²„íŠ¼ í‘œì‹œ
  document.getElementById('sheets-btn').style.display = sheetsUrl ? 'flex' : 'none';

  box.classList.add('show');
}

// â”€â”€â”€ ì €ì¥ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function saveRecord() {
  if (!currentParsed) return;
  records.unshift({ ...currentParsed, savedAt: new Date().toISOString() });
  localStorage.setItem('inv_records', JSON.stringify(records));
  renderRecords();
  updateCount();
  showToast('âœ… ê¸°ë¡ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
  if (sheetsUrl) sendToSheets();
}

function renderRecords() {
  const container = document.getElementById('records-container');
  if (records.length === 0) {
    container.innerHTML = `<div class="empty-state"><div class="empty-icon">ğŸ“­</div>ì•„ì§ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.<br>ë©”ì‹œì§€ë¥¼ íŒŒì‹±í•˜ê³  ì €ì¥í•´ë³´ì„¸ìš”.</div>`;
    return;
  }

  const typeConfig = {
    'ë°°ë‹¹ê¸ˆ': { label: 'ë°°ë‹¹', bg: 'rgba(16,185,129,0.12)', color: 'var(--accent2)' },
    'ë§¤ìˆ˜': { label: 'ë§¤ìˆ˜', bg: 'rgba(59,130,246,0.12)', color: 'var(--accent)' },
    'ë§¤ë„': { label: 'ë§¤ë„', bg: 'rgba(239,68,68,0.12)', color: 'var(--danger)' },
    unknown: { label: 'ê¸°íƒ€', bg: 'rgba(148,163,184,0.12)', color: 'var(--text2)' },
  };

  container.innerHTML = `<div class="records-list">${records.map((r, i) => {
    const tc = typeConfig[r.type] || typeConfig.unknown;
    return `
    <div class="record-item">
      <div class="record-left">
        <div class="record-badge" style="background:${tc.bg};color:${tc.color}">${tc.label}</div>
        <div>
          <div class="record-name">${r.name || 'ì¢…ëª©ëª… ì—†ìŒ'}</div>
          <div class="record-date">${r.date || '-'} Â· ${r.broker || ''}</div>
        </div>
      </div>
      <div>
        <div class="record-amount" style="color:${r.type==='ë§¤ë„'?'var(--danger)':r.type==='ë§¤ìˆ˜'?'var(--accent)':'var(--accent2)'}">
          ${r.amountKRW ? Number(r.amountKRW).toLocaleString()+'ì›' : r.amountUSD ? 'USD '+r.amountUSD : r.price || '-'}
        </div>
        ${r.quantity ? `<div class="record-sub">${r.quantity}</div>` : ''}
      </div>
    </div>`;
  }).join('')}</div>`;
}

function updateCount() {
  document.getElementById('record-count').textContent = records.length;
}

// â”€â”€â”€ êµ¬ê¸€ ì‹œíŠ¸ ì „ì†¡ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function sendToSheets() {
  if (!sheetsUrl || !currentParsed) return;
  const btn = document.getElementById('sheets-btn');
  btn.textContent = 'ì „ì†¡ ì¤‘...';
  btn.disabled = true;

  const params = new URLSearchParams({
    date:      currentParsed.date      || '',
    type:      currentParsed.type      || '',
    market:    currentParsed.market    || '',
    broker:    currentParsed.broker    || '',
    name:      currentParsed.name      || '',
    amountKRW: currentParsed.amountKRW || '',
    amountUSD: currentParsed.amountUSD || '',
    quantity:  currentParsed.quantity  || '',
    price:     currentParsed.price     || '',
    account:   currentParsed.account   || '',
  });

  // fetch ëŒ€ì‹  <img> íƒœê·¸ë¡œ ìš”ì²­ â€” CORS ìš°íšŒ
  const url = `${sheetsUrl}?${params.toString()}`;
  const img = new Image();
  img.onload = img.onerror = function() {
    // ì‘ë‹µ ì½ê¸°ëŠ” ë¶ˆê°€ëŠ¥í•˜ì§€ë§Œ ìš”ì²­ì€ ì„œë²„ì— ë„ë‹¬í•¨
    showToast('âœ… ì „ì†¡í–ˆìŠµë‹ˆë‹¤! êµ¬ê¸€ ì‹œíŠ¸ì—ì„œ í™•ì¸í•´ì£¼ì„¸ìš”', 'success');
    btn.textContent = 'ğŸ“¤ êµ¬ê¸€ ì‹œíŠ¸ ì „ì†¡';
    btn.disabled = false;
  };
  img.src = url;

  // 3ì´ˆ í›„ì—ë„ ì½œë°± ì—†ìœ¼ë©´ ê°•ì œë¡œ ì™„ë£Œ ì²˜ë¦¬
  setTimeout(() => {
    if (btn.disabled) {
      showToast('âœ… ì „ì†¡í–ˆìŠµë‹ˆë‹¤! êµ¬ê¸€ ì‹œíŠ¸ì—ì„œ í™•ì¸í•´ì£¼ì„¸ìš”', 'success');
      btn.textContent = 'ğŸ“¤ êµ¬ê¸€ ì‹œíŠ¸ ì „ì†¡';
      btn.disabled = false;
    }
  }, 3000);
}

function openUrlTest() {
  const url = document.getElementById('sheets-url').value.trim();
  if (!url) { showToast('â— URLì„ ë¨¼ì € ì…ë ¥í•´ì£¼ì„¸ìš”', 'error'); return; }
  if (!url.includes('script.google.com') || !url.endsWith('/exec')) {
    showToast('âŒ URL í˜•ì‹ ì˜¤ë¥˜ â€” /exec ë¡œ ëë‚˜ì•¼ í•©ë‹ˆë‹¤', 'error');
    return;
  }
  window.open(url + '?test=1', '_blank');
}

function markConnected() {
  const url = document.getElementById('sheets-url').value.trim();
  if (!url) { showToast('â— URLì„ ë¨¼ì € ì…ë ¥í•´ì£¼ì„¸ìš”', 'error'); return; }
  sheetsUrl = url;
  localStorage.setItem('inv_sheets_url', sheetsUrl);
  updateStatus(true);
  showToast('âœ… ì—°ê²° ì„¤ì • ì™„ë£Œ! ì´ì œ ë°ì´í„°ë¥¼ ì „ì†¡í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤', 'success');
}

function embedUrl() {
  const url = document.getElementById('sheets-url').value.trim();
  if (!url) { showToast('â— URLì„ ë¨¼ì € ì…ë ¥í•´ì£¼ì„¸ìš”', 'error'); return; }

  // í˜„ì¬ HTML íŒŒì¼ ë‚´ìš©ì„ ì½ì–´ì„œ FIXED_SHEETS_URLì„ êµì²´ í›„ ë‹¤ìš´ë¡œë“œ
  const scripts = document.getElementsByTagName('script');
  let found = false;
  for (let s of scripts) {
    if (s.textContent.includes('FIXED_SHEETS_URL')) {
      // í˜„ì¬ í˜ì´ì§€ HTML ì „ì²´ë¥¼ ê°€ì ¸ì™€ì„œ URL êµì²´
      const html = document.documentElement.outerHTML;
      const updated = html.replace(
        /const FIXED_SHEETS_URL = '.*?';/,
        `const FIXED_SHEETS_URL = '${url}';`
      );
      // ìˆ˜ì •ëœ íŒŒì¼ ë‹¤ìš´ë¡œë“œ
      const blob = new Blob([updated], { type: 'text/html;charset=utf-8' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'investment-tracker.html';
      a.click();
      found = true;
      showToast('âœ… URLì´ ì €ì¥ëœ íŒŒì¼ì„ ë‹¤ìš´ë¡œë“œí–ˆìŠµë‹ˆë‹¤! ê¸°ì¡´ íŒŒì¼ê³¼ êµì²´í•´ì£¼ì„¸ìš”', 'success');
      break;
    }
  }
  if (!found) showToast('âŒ ì €ì¥ ì‹¤íŒ¨ â€” í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”', 'error');
}

function saveSettings() {
  sheetsUrl = document.getElementById('sheets-url').value.trim();
  localStorage.setItem('inv_sheets_url', sheetsUrl);
  updateStatus(!!sheetsUrl);
}

function updateStatus(ok) {
  const dot = document.getElementById('status-dot');
  const txt = document.getElementById('status-text');
  if (ok && sheetsUrl) {
    dot.className = 'status-dot connected';
    txt.textContent = 'êµ¬ê¸€ ì‹œíŠ¸ ì—°ë™ í™œì„±í™”ë¨';
  } else {
    dot.className = 'status-dot';
    txt.textContent = 'URLì„ ì…ë ¥í•˜ë©´ ì—°ë™ì´ í™œì„±í™”ë©ë‹ˆë‹¤';
  }
}

function clearInput() {
  document.getElementById('msg-input').value = '';
  document.getElementById('result-box').classList.remove('show');
  currentParsed = null;
}

function copyScript() {
  const text = document.getElementById('script-code').textContent;
  navigator.clipboard.writeText(text).then(() => showToast('ğŸ“‹ ìŠ¤í¬ë¦½íŠ¸ ë³µì‚¬ë¨', 'success'));
}


// â”€â”€â”€ ì¼ê´„ ê°€ì ¸ì˜¤ê¸° â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let bulkParsed = [];

function handleDrop(e) {
  e.preventDefault();
  document.getElementById('drop-zone').style.borderColor = 'var(--border)';
  const file = e.dataTransfer.files[0];
  if (file) readTxtFile(file);
}

function handleFileSelect(e) {
  const file = e.target.files[0];
  if (file) readTxtFile(file);
}

function readTxtFile(file) {
  const reader = new FileReader();
  reader.onload = function(e) {
    parseBulkMessages(e.target.result);
  };
  reader.readAsText(file, 'UTF-8');
}

function parseBulkMessages(text) {
  // ì¹´ì¹´ì˜¤í†¡ ëŒ€í™” í˜•ì‹ íŒŒì‹±
  // "YYYYë…„ MMì›” DDì¼ ì˜¤ì „/ì˜¤í›„ H:MM, ë°œì‹ ì : ë‚´ìš©"
  const msgPattern = /(\d{4}ë…„ \d{1,2}ì›” \d{1,2}ì¼ (?:ì˜¤ì „|ì˜¤í›„) \d{1,2}:\d{2}), [^:]+: (.+?)(?=\d{4}ë…„ \d{1,2}ì›” \d{1,2}ì¼ (?:ì˜¤ì „|ì˜¤í›„) \d{1,2}:\d{2}[\r\n,]|$)/gs;

  const INVEST_KEYWORDS = [
    'ë°°ë‹¹ê¸ˆ ì…ê¸ˆ ì•ˆë‚´',           // ì‚¼ì„±/í•œêµ­íˆ¬ì êµ­ë‚´ë°°ë‹¹
    'ETFë¶„ë°°ê¸ˆ ì…ê¸ˆ ì•ˆë‚´',        // ì‚¼ì„± ETFë¶„ë°°ê¸ˆ
    'ETF ë¶„ë°°ê¸ˆ ì…ê¸ˆ ì•ˆë‚´',       // í•œêµ­íˆ¬ì ETFë¶„ë°°ê¸ˆ
    'ETF ê²°ì‚°ë¶„ë°°ê¸ˆ ì…ê¸ˆ ì•ˆë‚´',   // í•œêµ­íˆ¬ì ê²°ì‚°ë¶„ë°°ê¸ˆ
    'ë¶„ë°°ê¸ˆ ì…ê¸ˆì•ˆë‚´',            // ì‚¼ì„± ë¶„ë°°ê¸ˆì…ê¸ˆì•ˆë‚´
    'í•´ì™¸ì£¼ì‹ ê¶Œë¦¬ì²˜ë¦¬ê²°ê³¼ ì•ˆë‚´', // ì‚¼ì„± í•´ì™¸ë°°ë‹¹
    'í•´ì™¸ì£¼ì‹ ë§¤ë§¤ ì²´ê²° ì•ˆë‚´',    // ì‚¼ì„± í•´ì™¸ë§¤ìˆ˜/ë§¤ë„
    'ì£¼ì‹ì²´ê²°ì•ˆë‚´',               // ì‚¼ì„± êµ­ë‚´ì²´ê²°
    '[ë¯¸ë‹ˆìŠ¤íƒ]',                 // í•œêµ­íˆ¬ì ë¯¸ë‹ˆìŠ¤íƒ
  ];

  bulkParsed = [];
  let match;

  while ((match = msgPattern.exec(text)) !== null) {
    const [, dateStr, body] = match;
    const cleanBody = body.trim();

    // íˆ¬ì ê´€ë ¨ ë©”ì‹œì§€ë§Œ í•„í„°
    if (!INVEST_KEYWORDS.some(k => cleanBody.includes(k))) continue;
    // ë°°ë‹¹(í˜„ê¸ˆ) ì•„ë‹Œ í•´ì™¸ ê¶Œë¦¬ì²˜ë¦¬ ì œì™¸ (ì£¼ì‹ë³‘í•© ë“±)
    if (cleanBody.includes('í•´ì™¸ì£¼ì‹ ê¶Œë¦¬ì²˜ë¦¬ê²°ê³¼ ì•ˆë‚´') && !cleanBody.includes('ë°°ë‹¹(í˜„ê¸ˆ)')) continue;

    // ë‚ ì§œ íŒŒì‹± (ì¹´ì¹´ì˜¤í†¡ í—¤ë” ë‚ ì§œ ì‚¬ìš©)
    const msgDate = parseKakaoDate(dateStr);

    // ì£¼ì‹ì²´ê²°ì•ˆë‚´ â€” ì‚¼ì„±ì¦ê¶Œ í•œ ì¤„ í˜•ì‹
    if (cleanBody.includes('ì£¼ì‹ì²´ê²°ì•ˆë‚´')) {
      const parsed = parseKakaoTrade(cleanBody, msgDate);
      if (parsed) bulkParsed.push(parsed);
      continue;
    }

    // ë¯¸ë‹ˆìŠ¤íƒ ì²´ê²° â€” í•œêµ­íˆ¬ì í˜•ì‹
    if (cleanBody.includes('[ë¯¸ë‹ˆìŠ¤íƒ]') && cleanBody.includes('ì²´ê²°')) {
      const parsed = parseMinistock(cleanBody, msgDate);
      if (parsed) bulkParsed.push(parsed);
      continue;
    }

    // ë°°ë‹¹/ë¶„ë°°ê¸ˆ â€” ì—¬ëŸ¬ ì¤„ í˜•ì‹: extractData ì¬í™œìš©
    const parsed = extractData(cleanBody);
    // dateAuto=true(ë©”ì‹œì§€ ë‚´ ë‚ ì§œ ì—†ìŒ) â†’ ì¹´ì¹´ì˜¤í†¡ í—¤ë” ë‚ ì§œë¡œ ë®ì–´ì“°ê¸°
    if (parsed.dateAuto || !parsed.date) {
      parsed.date = msgDate;
      parsed.dateAuto = false;
    }
    if (parsed.type !== 'unknown') bulkParsed.push(parsed);
  }

  renderBulkPreview();
}

function parseMinistock(body, date) {
  // [ë¯¸ë‹ˆìŠ¤íƒ] í…ŒìŠ¬ë¼(TSLA)\n- ì£¼ë¬¸ìœ í˜• : êµ¬ë§¤(ë§¤ìˆ˜) - ì²´ê²°ê¸ˆì•¡ : 1,998ì› - ì£¼ë¬¸ì¼ì : 2020.09.15
  const nameMatch = body.match(/([^\r\n(]+)\(([A-Z0-9]+)\)[\r\n]/);
  const typeMatch = body.match(/êµ¬ë§¤\(ë§¤ìˆ˜\)|íŒë§¤\(ë§¤ë„\)/);
  const amtMatch  = body.match(/ì²´ê²°ê¸ˆì•¡\s*:\s*([\d,]+)ì›/);
  const dateMatch = body.match(/ì£¼ë¬¸ì¼ì\s*:\s*([\d.]+)/);

  if (!nameMatch || !typeMatch) return null;

  const ticker = nameMatch[2].trim();
  const type   = typeMatch[0].includes('ë§¤ìˆ˜') ? 'ë§¤ìˆ˜' : 'ë§¤ë„';

  let tradeDate = date;
  if (dateMatch) {
    const parts = dateMatch[1].split('.');
    tradeDate = parts[0] + '-' + parts[1].padStart(2,'0') + '-' + parts[2].padStart(2,'0');
  }

  return {
    date:      tradeDate,
    type:      type,
    broker:    'í•œêµ­íˆ¬ìì¦ê¶Œ',
    name:      ticker,
    amountKRW: amtMatch ? amtMatch[1].replace(/,/g,'') : '',
    amountUSD: '',
    quantity:  '',
    price:     '',
    account:   '',
    market:    'í•´ì™¸',
    currency:  'KRW',
  };
}

function parseKakaoDate(str) {
  // "2024ë…„ 8ì›” 7ì¼ ì˜¤ì „ 10:27" â†’ "2024-08-07"
  const m = str.match(/(\d{4})ë…„ (\d{1,2})ì›” (\d{1,2})ì¼/);
  if (!m) return '';
  return `${m[1]}-${m[2].padStart(2,'0')}-${m[3].padStart(2,'0')}`;
}

function parseKakaoTrade(body, date) {
  // "[ì‚¼ì„±ì¦ê¶Œ]<ì£¼ì‹ì²´ê²°ì•ˆë‚´> 71518***** - 14 ì§„ì–‘í™€ë”©ìŠ¤ ë§¤ìˆ˜10ì£¼\n3,180ì› ì²´ê²°(1ì°¨)"
  const tradeMatch = body.match(/ì£¼ì‹ì²´ê²°ì•ˆë‚´>[\s\S]*?[\d\*\- ]+\s+(.+?)\s*(ë§¤ìˆ˜|ë§¤ë„)(\d+)ì£¼[\r\n]+([,\d]+)ì›\s*ì²´ê²°/);
  if (!tradeMatch) return null;

  const [, name, type, qty, price] = tradeMatch;
  const priceNum = price.replace(/,/g, '');
  const qtyNum = qty;
  const amount = String(parseInt(priceNum) * parseInt(qtyNum));

  return {
    date: date,
    type: type,
    broker: 'ì‚¼ì„±ì¦ê¶Œ',
    name: name.trim(),
    amountKRW: amount,
    amountUSD: '',
    quantity: qtyNum,
    price: priceNum,
    account: '',
    market: 'êµ­ë‚´',
    currency: 'KRW',
  };
}

function renderBulkPreview() {
  const preview = document.getElementById('bulk-preview');
  const list = document.getElementById('bulk-list');
  const stats = document.getElementById('bulk-stats');

  if (bulkParsed.length === 0) {
    showToast('â— íˆ¬ì ê´€ë ¨ ë©”ì‹œì§€ë¥¼ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤', 'error');
    return;
  }

  preview.style.display = 'block';

  // í†µê³„
  const cnt = { 'ë°°ë‹¹ê¸ˆ': 0, 'ë§¤ìˆ˜': 0, 'ë§¤ë„': 0 };
  bulkParsed.forEach(r => { if (cnt[r.type] !== undefined) cnt[r.type]++; else cnt['ê¸°íƒ€'] = (cnt['ê¸°íƒ€']||0)+1; });

  const colors = { 'ë°°ë‹¹ê¸ˆ': 'var(--accent2)', 'ë§¤ìˆ˜': 'var(--accent)', 'ë§¤ë„': 'var(--danger)' };
  stats.innerHTML = [
    { label: 'ì „ì²´', val: bulkParsed.length, color: 'var(--text2)' },
    ...Object.entries(cnt).map(([k, v]) => ({ label: k, val: v, color: colors[k] || 'var(--text3)' }))
  ].map(s => `
    <div style="background:var(--surface2);border:1px solid var(--border);border-radius:8px;padding:10px 16px;text-align:center">
      <div style="font-size:20px;font-weight:700;color:${s.color};font-family:'DM Mono',monospace">${s.val}</div>
      <div style="font-size:11px;color:var(--text3);margin-top:2px">${s.label}</div>
    </div>
  `).join('');

  // ë¦¬ìŠ¤íŠ¸
  const typeColors = { 'ë°°ë‹¹ê¸ˆ': 'var(--accent2)', 'ë§¤ìˆ˜': 'var(--accent)', 'ë§¤ë„': 'var(--danger)' };
  list.innerHTML = bulkParsed.map((r, i) => `
    <div style="background:var(--surface2);border:1px solid var(--border);border-radius:8px;padding:10px 14px;display:flex;align-items:center;justify-content:space-between;gap:10px">
      <div style="display:flex;align-items:center;gap:10px;min-width:0">
        <div style="font-size:10px;font-weight:700;padding:2px 8px;border-radius:5px;background:${typeColors[r.type]||'var(--text3)'}22;color:${typeColors[r.type]||'var(--text3)'};flex-shrink:0">${r.type}</div>
        <div style="min-width:0">
          <div style="font-size:13px;font-weight:500;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:280px">${r.name || '-'}</div>
          <div style="font-size:11px;color:var(--text3);font-family:'DM Mono',monospace">${r.date} Â· ${r.broker}</div>
        </div>
      </div>
      <div style="text-align:right;flex-shrink:0">
        <div style="font-size:13px;font-family:'DM Mono',monospace;color:${typeColors[r.type]||'var(--text2)'}">
          ${r.amountKRW ? Number(r.amountKRW).toLocaleString()+'ì›' : r.amountUSD ? 'USD '+r.amountUSD : '-'}
        </div>
        ${r.quantity ? `<div style="font-size:11px;color:var(--text3)">${r.quantity}ì£¼</div>` : ''}
      </div>
    </div>
  `).join('');

  showToast(`âœ… ${bulkParsed.length}ê±´ íŒŒì‹± ì™„ë£Œ!`, 'success');
}

function bulkSaveLocal() {
  bulkParsed.forEach(r => {
    records.unshift({ ...r, savedAt: new Date().toISOString() });
  });
  localStorage.setItem('inv_records', JSON.stringify(records));
  renderRecords();
  updateCount();
  showToast(`âœ… ${bulkParsed.length}ê±´ ë¡œì»¬ ì €ì¥ ì™„ë£Œ!`, 'success');
}

async function bulkSendAll() {
  if (!sheetsUrl) {
    showToast('â— êµ¬ê¸€ ì‹œíŠ¸ URLì„ ë¨¼ì € ì„¤ì •í•´ì£¼ì„¸ìš”', 'error');
    return;
  }
  if (bulkParsed.length === 0) return;

  const btn = document.getElementById('bulk-send-btn');
  const progress = document.getElementById('bulk-progress');
  const bar = document.getElementById('progress-bar');
  const progressText = document.getElementById('progress-text');

  btn.disabled = true;
  progress.style.display = 'block';

  let sent = 0;
  const total = bulkParsed.length;
  const DELAY = 300; // Apps Script ê³¼ë¶€í•˜ ë°©ì§€

  for (const r of bulkParsed) {
    const params = new URLSearchParams({
      date:      r.date      || '',
      type:      r.type      || '',
      market:    r.market    || '',
      broker:    r.broker    || '',
      name:      r.name      || '',
      amountKRW: r.amountKRW || '',
      amountUSD: r.amountUSD || '',
      quantity:  r.quantity  || '',
      price:     r.price     || '',
      account:   r.account   || '',
    });

    const img = new Image();
    img.src = `${sheetsUrl}?${params.toString()}`;

    sent++;
    const pct = Math.round((sent / total) * 100);
    bar.style.width = pct + '%';
    progressText.textContent = `${sent} / ${total} ì „ì†¡ ì¤‘...`;

    await new Promise(r => setTimeout(r, DELAY));
  }

  // ë¡œì»¬ì—ë„ ì €ì¥
  bulkSaveLocal();
  btn.disabled = false;
  progressText.textContent = `âœ… ${total}ê±´ ì „ì†¡ ì™„ë£Œ!`;
  showToast(`âœ… ${total}ê±´ êµ¬ê¸€ ì‹œíŠ¸ ì „ì†¡ ì™„ë£Œ!`, 'success');
}

// â”€â”€â”€ í† ìŠ¤íŠ¸ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showToast(msg, type = '') {
  const toast = document.getElementById('toast');
  toast.textContent = msg;
  toast.className = 'toast show ' + type;
  setTimeout(() => toast.className = 'toast', 2800);
}
</script>
</body>
</html>

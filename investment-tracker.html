<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>íˆ¬ì ê¸°ë¡ íŠ¸ë˜ì»¤</title>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #0a0e1a;
    --surface: #111827;
    --surface2: #1a2235;
    --border: #1e2d45;
    --accent: #3b82f6;
    --accent2: #10b981;
    --accent3: #f59e0b;
    --danger: #ef4444;
    --text: #e2e8f0;
    --text2: #94a3b8;
    --text3: #4b6280;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: 'Noto Sans KR', sans-serif;
    min-height: 100vh;
    overflow-x: hidden;
  }

  /* ë°°ê²½ ê·¸ë¦¬ë“œ */
  body::before {
    content: '';
    position: fixed;
    inset: 0;
    background-image:
      linear-gradient(rgba(59,130,246,0.03) 1px, transparent 1px),
      linear-gradient(90deg, rgba(59,130,246,0.03) 1px, transparent 1px);
    background-size: 40px 40px;
    pointer-events: none;
    z-index: 0;
  }

  .container {
    max-width: 860px;
    margin: 0 auto;
    padding: 40px 20px;
    position: relative;
    z-index: 1;
  }

  /* í—¤ë” */
  header {
    margin-bottom: 40px;
  }

  .header-top {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-bottom: 6px;
  }

  .logo-dot {
    width: 10px; height: 10px;
    border-radius: 50%;
    background: var(--accent);
    box-shadow: 0 0 12px var(--accent);
    animation: pulse 2s infinite;
  }

  @keyframes pulse {
    0%, 100% { opacity: 1; transform: scale(1); }
    50% { opacity: 0.6; transform: scale(0.85); }
  }

  h1 {
    font-size: 22px;
    font-weight: 700;
    letter-spacing: -0.5px;
    color: var(--text);
  }

  .subtitle {
    font-size: 13px;
    color: var(--text3);
    font-weight: 300;
    margin-left: 22px;
  }

  /* íƒ­ */
  .tabs {
    display: flex;
    gap: 4px;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 4px;
    margin-bottom: 28px;
  }

  .tab {
    flex: 1;
    padding: 10px;
    border: none;
    background: transparent;
    color: var(--text2);
    border-radius: 9px;
    cursor: pointer;
    font-family: inherit;
    font-size: 13px;
    font-weight: 500;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 6px;
  }

  .tab.active {
    background: var(--surface2);
    color: var(--text);
    box-shadow: 0 2px 8px rgba(0,0,0,0.3);
  }

  .tab-icon { font-size: 15px; }

  /* ì¹´ë“œ */
  .card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 16px;
    padding: 24px;
    margin-bottom: 16px;
  }

  .card-title {
    font-size: 12px;
    font-weight: 500;
    color: var(--text3);
    text-transform: uppercase;
    letter-spacing: 1px;
    margin-bottom: 14px;
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .card-title::after {
    content: '';
    flex: 1;
    height: 1px;
    background: var(--border);
  }

  /* í…ìŠ¤íŠ¸ ì˜ì—­ */
  .paste-area {
    width: 100%;
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 14px 16px;
    color: var(--text);
    font-family: 'DM Mono', monospace;
    font-size: 12.5px;
    line-height: 1.7;
    resize: vertical;
    min-height: 130px;
    outline: none;
    transition: border-color 0.2s;
  }

  .paste-area:focus {
    border-color: var(--accent);
  }

  .paste-area::placeholder { color: var(--text3); }

  /* ë²„íŠ¼ */
  .btn-row {
    display: flex;
    gap: 10px;
    margin-top: 14px;
  }

  .btn {
    padding: 10px 20px;
    border-radius: 9px;
    border: none;
    font-family: inherit;
    font-size: 13px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    gap: 6px;
  }

  .btn-primary {
    background: var(--accent);
    color: white;
    flex: 1;
  }

  .btn-primary:hover { background: #2563eb; transform: translateY(-1px); }
  .btn-primary:active { transform: translateY(0); }

  .btn-ghost {
    background: var(--surface2);
    color: var(--text2);
    border: 1px solid var(--border);
  }

  .btn-ghost:hover { border-color: var(--text3); color: var(--text); }

  /* íŒŒì‹± ê²°ê³¼ */
  .result-box {
    display: none;
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 10px;
    overflow: hidden;
    margin-top: 16px;
  }

  .result-box.show { display: block; animation: fadeIn 0.3s ease; }

  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(6px); }
    to { opacity: 1; transform: translateY(0); }
  }

  .result-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 12px 16px;
    border-bottom: 1px solid var(--border);
  }

  .result-type {
    font-size: 11px;
    font-weight: 700;
    letter-spacing: 1px;
    text-transform: uppercase;
    padding: 3px 10px;
    border-radius: 20px;
  }

  .type-dividend { background: rgba(16,185,129,0.15); color: var(--accent2); }
  .type-buy { background: rgba(59,130,246,0.15); color: var(--accent); }
  .type-sell { background: rgba(239,68,68,0.15); color: var(--danger); }
  .type-unknown { background: rgba(148,163,184,0.15); color: var(--text2); }

  .result-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 0;
  }

  .result-item {
    padding: 12px 16px;
    border-bottom: 1px solid var(--border);
    border-right: 1px solid var(--border);
  }

  .result-item:nth-child(even) { border-right: none; }
  .result-item:nth-last-child(-n+2) { border-bottom: none; }

  .result-label {
    font-size: 11px;
    color: var(--text3);
    margin-bottom: 4px;
    font-weight: 500;
  }

  .result-value {
    font-size: 14px;
    color: var(--text);
    font-family: 'DM Mono', monospace;
    font-weight: 500;
  }

  .result-value.highlight { color: var(--accent2); }

  /* êµ¬ê¸€ ì‹œíŠ¸ ì„¤ì • */
  .input-group {
    display: flex;
    flex-direction: column;
    gap: 8px;
    margin-bottom: 14px;
  }

  .input-label {
    font-size: 12px;
    color: var(--text2);
    font-weight: 500;
  }

  .input-field {
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 9px;
    padding: 10px 14px;
    color: var(--text);
    font-family: 'DM Mono', monospace;
    font-size: 13px;
    outline: none;
    transition: border-color 0.2s;
    width: 100%;
  }

  .input-field:focus { border-color: var(--accent); }
  .input-field::placeholder { color: var(--text3); }

  /* ì—°ë™ ìƒíƒœ */
  .status-row {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 13px;
    color: var(--text2);
    margin-top: 12px;
  }

  .status-dot {
    width: 7px; height: 7px;
    border-radius: 50%;
    background: var(--text3);
  }

  .status-dot.connected { background: var(--accent2); box-shadow: 0 0 6px var(--accent2); }
  .status-dot.error { background: var(--danger); }

  /* ê¸°ë¡ ë¦¬ìŠ¤íŠ¸ */
  .records-list {
    display: flex;
    flex-direction: column;
    gap: 8px;
  }

  .record-item {
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 14px 16px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    animation: fadeIn 0.3s ease;
  }

  .record-left { display: flex; align-items: center; gap: 12px; }

  .record-badge {
    font-size: 10px;
    font-weight: 700;
    letter-spacing: 0.5px;
    padding: 3px 8px;
    border-radius: 6px;
    min-width: 48px;
    text-align: center;
  }

  .record-name { font-size: 14px; font-weight: 500; }
  .record-date { font-size: 11px; color: var(--text3); margin-top: 2px; font-family: 'DM Mono', monospace; }

  .record-amount {
    font-family: 'DM Mono', monospace;
    font-size: 14px;
    font-weight: 500;
    text-align: right;
  }

  .record-sub {
    font-size: 11px;
    color: var(--text3);
    margin-top: 2px;
    font-family: 'DM Mono', monospace;
  }

  /* ì•Œë¦¼ í† ìŠ¤íŠ¸ */
  .toast {
    position: fixed;
    bottom: 24px;
    left: 50%;
    transform: translateX(-50%) translateY(80px);
    background: var(--surface);
    border: 1px solid var(--border);
    color: var(--text);
    padding: 12px 20px;
    border-radius: 12px;
    font-size: 13px;
    display: flex;
    align-items: center;
    gap: 8px;
    box-shadow: 0 8px 32px rgba(0,0,0,0.4);
    z-index: 100;
    transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
    white-space: nowrap;
  }

  .toast.show { transform: translateX(-50%) translateY(0); }
  .toast.success { border-color: var(--accent2); }
  .toast.error { border-color: var(--danger); }

  /* ë„ì›€ë§ */
  .help-box {
    background: rgba(59,130,246,0.06);
    border: 1px solid rgba(59,130,246,0.2);
    border-radius: 10px;
    padding: 14px 16px;
    font-size: 12.5px;
    color: var(--text2);
    line-height: 1.7;
    margin-top: 14px;
  }

  .help-box strong { color: var(--accent); }

  .empty-state {
    text-align: center;
    padding: 40px 20px;
    color: var(--text3);
    font-size: 13px;
  }

  .empty-icon { font-size: 32px; margin-bottom: 10px; }

  /* êµ¬ê¸€ ì‹œíŠ¸ ê°€ì´ë“œ */
  .step-list {
    display: flex;
    flex-direction: column;
    gap: 12px;
    margin-top: 4px;
  }

  .step {
    display: flex;
    gap: 12px;
    align-items: flex-start;
  }

  .step-num {
    width: 22px; height: 22px;
    border-radius: 50%;
    background: rgba(59,130,246,0.15);
    color: var(--accent);
    font-size: 11px;
    font-weight: 700;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
    margin-top: 1px;
  }

  .step-text { font-size: 13px; color: var(--text2); line-height: 1.6; }
  .step-text code {
    background: var(--surface2);
    border: 1px solid var(--border);
    padding: 1px 6px;
    border-radius: 4px;
    font-family: 'DM Mono', monospace;
    font-size: 11.5px;
    color: var(--accent2);
  }

  .script-block {
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 14px 16px;
    margin-top: 10px;
    font-family: 'DM Mono', monospace;
    font-size: 11.5px;
    color: var(--accent2);
    line-height: 1.8;
    white-space: pre;
    overflow-x: auto;
    position: relative;
  }

  .copy-btn {
    position: absolute;
    top: 10px; right: 10px;
    background: var(--surface);
    border: 1px solid var(--border);
    color: var(--text2);
    padding: 4px 10px;
    border-radius: 6px;
    font-size: 11px;
    cursor: pointer;
    font-family: inherit;
    transition: all 0.2s;
  }

  .copy-btn:hover { border-color: var(--accent); color: var(--accent); }

  @media (max-width: 600px) {
    .result-grid { grid-template-columns: 1fr; }
    .result-item { border-right: none !important; }
    .result-item:nth-last-child(-n+2) { border-bottom: 1px solid var(--border); }
    .result-item:last-child { border-bottom: none; }
  }
</style>
</head>
<body>
<div class="container">
  <header>
    <div class="header-top">
      <div class="logo-dot"></div>
      <h1>íˆ¬ì ê¸°ë¡ íŠ¸ë˜ì»¤</h1>
    </div>
    <div class="subtitle">ì¹´ì¹´ì˜¤í†¡ ì•Œë¦¼ â†’ ìë™ íŒŒì‹± â†’ êµ¬ê¸€ ì‹œíŠ¸ ê¸°ë¡</div>
  </header>

  <div class="tabs">
    <button class="tab active" onclick="switchTab('parse')">
      <span class="tab-icon">ğŸ“‹</span> ë©”ì‹œì§€ íŒŒì‹±
    </button>
    <button class="tab" onclick="switchTab('records')">
      <span class="tab-icon">ğŸ“Š</span> ê¸°ë¡ <span id="record-count" style="background:rgba(59,130,246,0.2);color:var(--accent);padding:1px 7px;border-radius:10px;font-size:11px;margin-left:2px">0</span>
    </button>
    <button class="tab" onclick="switchTab('settings')">
      <span class="tab-icon">âš™ï¸</span> êµ¬ê¸€ ì‹œíŠ¸ ì—°ë™
    </button>
  </div>

  <!-- íŒŒì‹± íƒ­ -->
  <div id="tab-parse">
    <div class="card">
      <div class="card-title">ì¹´ì¹´ì˜¤í†¡ ë©”ì‹œì§€ ë¶™ì—¬ë„£ê¸°</div>
      <textarea class="paste-area" id="msg-input" placeholder="ì¹´ì¹´ì˜¤í†¡ì—ì„œ ë³µì‚¬í•œ ë©”ì‹œì§€ë¥¼ ì—¬ê¸°ì— ë¶™ì—¬ë„£ìœ¼ì„¸ìš”.

ì˜ˆì‹œ:
[ì‚¼ì„±ì¦ê¶Œ] &lt;ë°°ë‹¹ê¸ˆ ì…ê¸ˆ ì•ˆë‚´&gt;
-ì¢…ëª©ëª… : ë§¥ì¿¼ë¦¬ì¸í”„ë¼
-ì„¸í›„ ë°°ë‹¹ê¸ˆì•¡ : 100,320ì›
..."></textarea>
      <div class="btn-row">
        <button class="btn btn-primary" onclick="parseMessage()">
          âš¡ ìë™ íŒŒì‹±
        </button>
        <button class="btn btn-ghost" onclick="clearInput()">ì§€ìš°ê¸°</button>
      </div>
    </div>

    <div class="result-box" id="result-box">
      <div class="result-header">
        <span id="result-type-badge" class="result-type"></span>
        <span style="font-size:12px;color:var(--text3)" id="result-source"></span>
      </div>
      <div class="result-grid" id="result-grid"></div>
      <div style="padding:12px 16px;border-top:1px solid var(--border)">
        <div class="btn-row">
          <button class="btn btn-primary" onclick="saveRecord()" id="save-btn">
            ğŸ’¾ ê¸°ë¡ ì €ì¥
          </button>
          <button class="btn btn-ghost" id="sheets-btn" onclick="sendToSheets()" style="display:none">
            ğŸ“¤ êµ¬ê¸€ ì‹œíŠ¸ ì „ì†¡
          </button>
        </div>
      </div>
    </div>

    <div class="help-box">
      <strong>ì§€ì› ë©”ì‹œì§€ í˜•ì‹</strong><br>
      ì‚¼ì„±ì¦ê¶Œ ë°°ë‹¹ê¸ˆ ì…ê¸ˆ ì•ˆë‚´ Â· ë§¤ìˆ˜/ë§¤ë„ ì²´ê²° ì•Œë¦¼<br>
      í‚¤ì›€ì¦ê¶Œ, NHíˆ¬ìì¦ê¶Œ, ë¯¸ë˜ì—ì…‹ ë“± ë‹¤ë¥¸ ì¦ê¶Œì‚¬ë„ ë©”ì‹œì§€ë¥¼ ë¶™ì—¬ë„£ìœ¼ë©´ ìë™ ì¸ì‹í•©ë‹ˆë‹¤.
    </div>
  </div>

  <!-- ê¸°ë¡ íƒ­ -->
  <div id="tab-records" style="display:none">
    <div class="card">
      <div class="card-title">íˆ¬ì ê¸°ë¡</div>
      <div id="records-container">
        <div class="empty-state">
          <div class="empty-icon">ğŸ“­</div>
          ì•„ì§ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.<br>ë©”ì‹œì§€ë¥¼ íŒŒì‹±í•˜ê³  ì €ì¥í•´ë³´ì„¸ìš”.
        </div>
      </div>
    </div>
  </div>

  <!-- ì„¤ì • íƒ­ -->
  <div id="tab-settings" style="display:none">
    <div class="card">
      <div class="card-title">êµ¬ê¸€ ì‹œíŠ¸ ì—°ë™ ì„¤ì •</div>

      <div class="input-group">
        <div class="input-label">ì›¹ì•± URL (Google Apps Script ë°°í¬ URL)</div>
        <input class="input-field" id="sheets-url" type="text"
          placeholder="https://script.google.com/macros/s/XXXXX/exec"
          oninput="saveSettings()">
      </div>

      <div class="status-row">
        <div class="status-dot" id="status-dot"></div>
        <span id="status-text">URLì„ ì…ë ¥í•˜ë©´ ì—°ë™ì´ í™œì„±í™”ë©ë‹ˆë‹¤</span>
      </div>

      <div style="display:flex;gap:8px;margin-top:14px">
        <button class="btn btn-ghost" style="flex:1" onclick="openUrlTest()">
          ğŸ”— URL ë¸Œë¼ìš°ì €ì—ì„œ ì—´ì–´ì„œ í™•ì¸
        </button>
        <button class="btn btn-primary" style="flex:1" onclick="markConnected()">
          âœ… ì—°ê²°ëì–´ìš” (ìˆ˜ë™ í™•ì¸)
        </button>
      </div>
      <div class="help-box" style="margin-top:10px">
        <strong>í™•ì¸ ë°©ë²•</strong><br>
        1. ìœ„ ë²„íŠ¼ìœ¼ë¡œ URLì„ ë¸Œë¼ìš°ì €ì—ì„œ ì—´ì–´ë³´ì„¸ìš”<br>
        2. í™”ë©´ì— <code style="background:var(--surface);padding:1px 5px;border-radius:3px;font-family:monospace">{"result":"ok"}</code> ê°€ ë³´ì´ë©´ ì •ìƒì…ë‹ˆë‹¤<br>
        3. ì •ìƒì´ë©´ ì˜¤ë¥¸ìª½ "ì—°ê²°ëì–´ìš”" ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”
      </div>
    </div>

    <div class="card">
      <div class="card-title">Google Apps Script ì„¤ì • ë°©ë²•</div>
      <div class="step-list">
        <div class="step">
          <div class="step-num">1</div>
          <div class="step-text">êµ¬ê¸€ ë“œë¼ì´ë¸Œì—ì„œ <strong style="color:var(--text)">ìŠ¤í”„ë ˆë“œì‹œíŠ¸</strong>ë¥¼ ìƒˆë¡œ ë§Œë“œì„¸ìš”.<br>
          ì‹œíŠ¸ ì´ë¦„ì„ <code>íˆ¬ìê¸°ë¡</code>ìœ¼ë¡œ ë³€ê²½í•˜ì„¸ìš”.</div>
        </div>
        <div class="step">
          <div class="step-num">2</div>
          <div class="step-text">ìƒë‹¨ ë©”ë‰´ <code>í™•ì¥ í”„ë¡œê·¸ë¨</code> â†’ <code>Apps Script</code> í´ë¦­</div>
        </div>
        <div class="step">
          <div class="step-num">3</div>
          <div class="step-text">ì•„ë˜ ìŠ¤í¬ë¦½íŠ¸ë¥¼ ë³µì‚¬í•´ì„œ ë¶™ì—¬ë„£ê³  ì €ì¥í•˜ì„¸ìš” (<code>Ctrl+S</code>)</div>
        </div>
        <div class="step">
          <div class="step-num">4</div>
          <div class="step-text"><code>ë°°í¬</code> â†’ <code>ìƒˆ ë°°í¬</code> â†’ ìœ í˜•: <code>ì›¹ ì•±</code> â†’ ì•¡ì„¸ìŠ¤: <code>ëª¨ë“  ì‚¬ìš©ì</code> â†’ ë°°í¬</div>
        </div>
        <div class="step">
          <div class="step-num">5</div>
          <div class="step-text">ìƒì„±ëœ <strong style="color:var(--text)">ì›¹ ì•± URL</strong>ì„ ìœ„ ì…ë ¥ì°½ì— ë¶™ì—¬ë„£ìœ¼ì„¸ìš”</div>
        </div>
      </div>

      <div class="script-block" id="script-code">function doGet(e) {
  try {
    var p = e && e.parameter ? e.parameter : {};

    var ss = SpreadsheetApp.getActiveSpreadsheet();
    var sheet = ss.getSheetByName('íˆ¬ìê¸°ë¡') || ss.getActiveSheet();

    // í—¤ë” ìë™ ìƒì„±
    if (sheet.getLastRow() === 0) {
      sheet.appendRow([
        'ë‚ ì§œ','ì¢…ë¥˜','ì¦ê¶Œì‚¬','ì¢…ëª©ëª…',
        'ê¸ˆì•¡','ìˆ˜ëŸ‰','ë‹¨ê°€','ê³„ì¢Œë²ˆí˜¸','ê¸°ë¡ì¼ì‹œ'
      ]);
    }

    // ì—°ê²° í…ŒìŠ¤íŠ¸ (ë°ì´í„° ì—†ì´ test=1ë§Œ ì˜¨ ê²½ìš°)
    if (p.test && !p.name) {
      return response({result: 'ok', message: 'ì—°ê²° ì„±ê³µ!'});
    }

    sheet.appendRow([
      decodeURIComponent(p.date     || ''),
      decodeURIComponent(p.type     || ''),
      decodeURIComponent(p.broker   || ''),
      decodeURIComponent(p.name     || ''),
      decodeURIComponent(p.amount   || ''),
      decodeURIComponent(p.quantity || ''),
      decodeURIComponent(p.price    || ''),
      decodeURIComponent(p.account  || ''),
      new Date().toLocaleString('ko-KR')
    ]);

    return response({result: 'success'});

  } catch(err) {
    return response({result: 'error', message: err.toString()});
  }
}

function response(obj) {
  return ContentService
    .createTextOutput(JSON.stringify(obj))
    .setMimeType(ContentService.MimeType.JSON);
}</div>
      <button class="copy-btn" onclick="copyScript()">ë³µì‚¬</button>
    </div>
  </div>

</div>

<div class="toast" id="toast"></div>

<script>
// â”€â”€â”€ ìƒíƒœ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let records = JSON.parse(localStorage.getItem('inv_records') || '[]');
let currentParsed = null;
let sheetsUrl = localStorage.getItem('inv_sheets_url') || '';

// ì´ˆê¸°í™”
window.onload = () => {
  if (sheetsUrl) {
    document.getElementById('sheets-url').value = sheetsUrl;
    updateStatus(true);
  }
  renderRecords();
  updateCount();
};

// â”€â”€â”€ íƒ­ ì „í™˜ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function switchTab(name) {
  ['parse','records','settings'].forEach(t => {
    document.getElementById('tab-'+t).style.display = t === name ? 'block' : 'none';
  });
  document.querySelectorAll('.tab').forEach((el, i) => {
    el.classList.toggle('active', ['parse','records','settings'][i] === name);
  });
}

// â”€â”€â”€ íŒŒì‹± â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function parseMessage() {
  const msg = document.getElementById('msg-input').value.trim();
  if (!msg) { showToast('â— ë©”ì‹œì§€ë¥¼ ë¨¼ì € ë¶™ì—¬ë„£ì–´ ì£¼ì„¸ìš”', 'error'); return; }

  const result = extractData(msg);
  currentParsed = result;
  showResult(result);
}

function extractData(msg) {
  const data = { raw: msg, type: 'unknown', broker: '', name: '', date: '',
    amount: '', quantity: '', price: '', account: '', taxBefore: '', tax: '' };

  // ì¦ê¶Œì‚¬ ê°ì§€ (ëŒ€ê´„í˜¸ í˜•ì‹ + ì¤„ë°”ê¿ˆ í˜•ì‹ ëª¨ë‘ ì§€ì›)
  const brokerMatch = msg.match(/\[([\wê°€-í£]+ì¦ê¶Œ|[\wê°€-í£]+íˆ¬ì|í‚¤ì›€|ë¯¸ë˜ì—ì…‹|í•œíˆ¬|KB|NH|ì‹ í•œ|ëŒ€ì‹ |í•˜ë‚˜|í•˜ì´|í† ìŠ¤|LS)\]/i)
    || msg.match(/^\[(í•œêµ­íˆ¬ì|ì‚¼ì„±ì¦ê¶Œ|í‚¤ì›€ì¦ê¶Œ|NHíˆ¬ì|ë¯¸ë˜ì—ì…‹|ì‹ í•œíˆ¬ì|KBì¦ê¶Œ|ëŒ€ì‹ ì¦ê¶Œ|í•˜ë‚˜ì¦ê¶Œ|í† ìŠ¤ì¦ê¶Œ)\]/m);
  if (brokerMatch) data.broker = brokerMatch[1];

  // í•œêµ­íˆ¬ì í˜•ì‹: ì²« ì¤„ì´ [í•œêµ­íˆ¬ì] ë‹¨ë…
  if (!data.broker && msg.match(/^\[í•œêµ­íˆ¬ì\]/m)) data.broker = 'í•œêµ­íˆ¬ìì¦ê¶Œ';

  // íƒ€ì… ê°ì§€
  if (msg.includes('ë°°ë‹¹ê¸ˆ') || msg.includes('ë¶„ë°°ê¸ˆ')) data.type = 'dividend';
  else if (msg.includes('ë§¤ìˆ˜') && msg.includes('ì²´ê²°')) data.type = 'buy';
  else if (msg.includes('ë§¤ë„') && msg.includes('ì²´ê²°')) data.type = 'sell';
  else if (msg.includes('ë§¤ìˆ˜')) data.type = 'buy';
  else if (msg.includes('ë§¤ë„')) data.type = 'sell';

  // ì¢…ëª©ëª… (* ë˜ëŠ” - ê¸€ë¨¸ë¦¬ ëª¨ë‘ ì§€ì›)
  const namePatterns = [
    /ì¢…ëª©ëª…\s*:\s*([^\n\r*â˜…âˆ¨http]+)/,
    /ì¢…ëª©\s*:\s*([^\n\r*â˜…âˆ¨http]+)/,
    /ìƒí’ˆëª…\s*:\s*([^\n\r*â˜…âˆ¨http]+)/,
  ];
  for (const p of namePatterns) {
    const m = msg.match(p);
    if (m) { data.name = m[1].trim(); break; }
  }

  // ê³„ì¢Œë²ˆí˜¸
  const accPatterns = [
    /ê³„ì¢Œë²ˆí˜¸\s*:\s*([\d\*\-]+)/,
    /ê³„ì¢Œ\s*:\s*([\d\*\-]+)/,
  ];
  for (const p of accPatterns) {
    const m = msg.match(p);
    if (m) { data.account = m[1].trim(); break; }
  }

  // ë‚ ì§œ
  const datePatterns = [
    /ì…ê¸ˆì¼ì\s*:\s*([\dë…„ì›”ì¼\s]+)/,       // í•œêµ­íˆ¬ì: ì…ê¸ˆì¼ì
    /ê¸°ì¤€ì¼\s*:\s*([\dë…„ì›”ì¼\s]+)/,
    /ì²´ê²°ì¼\s*:\s*([\dë…„ì›”ì¼\s\-\.]+)/,
    /(\d{4}ë…„\s*\d{1,2}ì›”\s*\d{1,2}ì¼)/,
    /(\d{4}[.\-]\d{2}[.\-]\d{2})/,
  ];
  for (const p of datePatterns) {
    const m = msg.match(p);
    if (m) { data.date = m[1].trim(); break; }
  }
  if (!data.date) data.date = new Date().toLocaleDateString('ko-KR');

  // ê¸ˆì•¡ íŒŒì‹±
  const amtPatterns = [
    { key: 'amount', patterns: [
      /ì„¸í›„\s*ë°°ë‹¹ê¸ˆì•¡\s*:\s*([\d,]+ì›?)/,
      /ì„¸í›„\s*ë¶„ë°°ê¸ˆì•¡\s*:\s*([\d,]+ì›?)/,
      /ì…ê¸ˆì•¡\s*:\s*([\d,]+ì›?)/,          // í•œêµ­íˆ¬ì
      /ì…ê¸ˆ\s*ê¸ˆì•¡\s*:\s*([\d,]+ì›?)/,
      /ì²´ê²°ê¸ˆì•¡\s*:\s*([\d,]+ì›?)/,
      /ê±°ë˜ê¸ˆì•¡\s*:\s*([\d,]+ì›?)/,
    ]},
    { key: 'taxBefore', patterns: [/ì„¸ì „\s*ë°°ë‹¹ê¸ˆì•¡\s*:\s*([\d,]+ì›?)/] },
    { key: 'tax', patterns: [/ì„¸ê¸ˆ\s*:\s*([\d,]+ì›?)/] },
    { key: 'quantity', patterns: [
      /ìˆ˜ëŸ‰\s*:\s*([\d,]+ì£¼?)/,
      /ì²´ê²°ìˆ˜ëŸ‰\s*:\s*([\d,]+ì£¼?)/,
    ]},
    { key: 'price', patterns: [
      /ë‹¨ê°€\s*:\s*([\d,]+ì›?)/,
      /ì²´ê²°ë‹¨ê°€\s*:\s*([\d,]+ì›?)/,
    ]},
  ];

  for (const { key, patterns } of amtPatterns) {
    for (const p of patterns) {
      const m = msg.match(p);
      if (m) { data[key] = m[1].trim(); break; }
    }
  }

  return data;
}

// â”€â”€â”€ ê²°ê³¼ í‘œì‹œ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showResult(data) {
  const box = document.getElementById('result-box');
  const badge = document.getElementById('result-type-badge');
  const grid = document.getElementById('result-grid');

  const typeMap = {
    dividend: { label: 'ë°°ë‹¹ê¸ˆ', cls: 'type-dividend' },
    buy: { label: 'ë§¤ìˆ˜', cls: 'type-buy' },
    sell: { label: 'ë§¤ë„', cls: 'type-sell' },
    unknown: { label: 'ì•Œ ìˆ˜ ì—†ìŒ', cls: 'type-unknown' },
  };

  const t = typeMap[data.type];
  badge.textContent = t.label;
  badge.className = 'result-type ' + t.cls;

  document.getElementById('result-source').textContent = data.broker || 'ì¦ê¶Œì‚¬ ë¯¸í™•ì¸';

  // í‘œì‹œí•  í•„ë“œ êµ¬ì„±
  let fields = [];
  if (data.name) fields.push({ label: 'ì¢…ëª©ëª…', value: data.name });
  if (data.date) fields.push({ label: 'ê¸°ì¤€ì¼ / ì²´ê²°ì¼', value: data.date });
  if (data.amount) fields.push({ label: 'ê¸ˆì•¡ (ì„¸í›„)', value: data.amount, hl: true });
  if (data.taxBefore) fields.push({ label: 'ì„¸ì „ ê¸ˆì•¡', value: data.taxBefore });
  if (data.tax) fields.push({ label: 'ì„¸ê¸ˆ', value: data.tax });
  if (data.quantity) fields.push({ label: 'ìˆ˜ëŸ‰', value: data.quantity });
  if (data.price) fields.push({ label: 'ë‹¨ê°€', value: data.price });
  if (data.account) fields.push({ label: 'ê³„ì¢Œë²ˆí˜¸', value: data.account });

  if (fields.length % 2 !== 0) fields.push({ label: '', value: '' });

  grid.innerHTML = fields.map(f => `
    <div class="result-item">
      <div class="result-label">${f.label}</div>
      <div class="result-value ${f.hl ? 'highlight' : ''}">${f.value || '-'}</div>
    </div>
  `).join('');

  // êµ¬ê¸€ ì‹œíŠ¸ ë²„íŠ¼ í‘œì‹œ
  document.getElementById('sheets-btn').style.display = sheetsUrl ? 'flex' : 'none';

  box.classList.add('show');
}

// â”€â”€â”€ ì €ì¥ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function saveRecord() {
  if (!currentParsed) return;
  records.unshift({ ...currentParsed, savedAt: new Date().toISOString() });
  localStorage.setItem('inv_records', JSON.stringify(records));
  renderRecords();
  updateCount();
  showToast('âœ… ê¸°ë¡ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
  if (sheetsUrl) sendToSheets();
}

function renderRecords() {
  const container = document.getElementById('records-container');
  if (records.length === 0) {
    container.innerHTML = `<div class="empty-state"><div class="empty-icon">ğŸ“­</div>ì•„ì§ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.<br>ë©”ì‹œì§€ë¥¼ íŒŒì‹±í•˜ê³  ì €ì¥í•´ë³´ì„¸ìš”.</div>`;
    return;
  }

  const typeConfig = {
    dividend: { label: 'ë°°ë‹¹', bg: 'rgba(16,185,129,0.12)', color: 'var(--accent2)' },
    buy: { label: 'ë§¤ìˆ˜', bg: 'rgba(59,130,246,0.12)', color: 'var(--accent)' },
    sell: { label: 'ë§¤ë„', bg: 'rgba(239,68,68,0.12)', color: 'var(--danger)' },
    unknown: { label: 'ê¸°íƒ€', bg: 'rgba(148,163,184,0.12)', color: 'var(--text2)' },
  };

  container.innerHTML = `<div class="records-list">${records.map((r, i) => {
    const tc = typeConfig[r.type] || typeConfig.unknown;
    return `
    <div class="record-item">
      <div class="record-left">
        <div class="record-badge" style="background:${tc.bg};color:${tc.color}">${tc.label}</div>
        <div>
          <div class="record-name">${r.name || 'ì¢…ëª©ëª… ì—†ìŒ'}</div>
          <div class="record-date">${r.date || '-'} Â· ${r.broker || ''}</div>
        </div>
      </div>
      <div>
        <div class="record-amount" style="color:${r.type==='sell'?'var(--danger)':r.type==='buy'?'var(--accent)':'var(--accent2)'}">${r.amount || r.price || '-'}</div>
        ${r.quantity ? `<div class="record-sub">${r.quantity}</div>` : ''}
      </div>
    </div>`;
  }).join('')}</div>`;
}

function updateCount() {
  document.getElementById('record-count').textContent = records.length;
}

// â”€â”€â”€ êµ¬ê¸€ ì‹œíŠ¸ ì „ì†¡ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function sendToSheets() {
  if (!sheetsUrl || !currentParsed) return;
  const btn = document.getElementById('sheets-btn');
  btn.textContent = 'ì „ì†¡ ì¤‘...';
  btn.disabled = true;

  const params = new URLSearchParams({
    date:     currentParsed.date    || '',
    type:     currentParsed.type    || '',
    broker:   currentParsed.broker  || '',
    name:     currentParsed.name    || '',
    amount:   currentParsed.amount  || '',
    quantity: currentParsed.quantity|| '',
    price:    currentParsed.price   || '',
    account:  currentParsed.account || '',
  });

  // fetch ëŒ€ì‹  <img> íƒœê·¸ë¡œ ìš”ì²­ â€” CORS ìš°íšŒ
  const url = `${sheetsUrl}?${params.toString()}`;
  const img = new Image();
  img.onload = img.onerror = function() {
    // ì‘ë‹µ ì½ê¸°ëŠ” ë¶ˆê°€ëŠ¥í•˜ì§€ë§Œ ìš”ì²­ì€ ì„œë²„ì— ë„ë‹¬í•¨
    showToast('âœ… ì „ì†¡í–ˆìŠµë‹ˆë‹¤! êµ¬ê¸€ ì‹œíŠ¸ì—ì„œ í™•ì¸í•´ì£¼ì„¸ìš”', 'success');
    btn.textContent = 'ğŸ“¤ êµ¬ê¸€ ì‹œíŠ¸ ì „ì†¡';
    btn.disabled = false;
  };
  img.src = url;

  // 3ì´ˆ í›„ì—ë„ ì½œë°± ì—†ìœ¼ë©´ ê°•ì œë¡œ ì™„ë£Œ ì²˜ë¦¬
  setTimeout(() => {
    if (btn.disabled) {
      showToast('âœ… ì „ì†¡í–ˆìŠµë‹ˆë‹¤! êµ¬ê¸€ ì‹œíŠ¸ì—ì„œ í™•ì¸í•´ì£¼ì„¸ìš”', 'success');
      btn.textContent = 'ğŸ“¤ êµ¬ê¸€ ì‹œíŠ¸ ì „ì†¡';
      btn.disabled = false;
    }
  }, 3000);
}

function openUrlTest() {
  const url = document.getElementById('sheets-url').value.trim();
  if (!url) { showToast('â— URLì„ ë¨¼ì € ì…ë ¥í•´ì£¼ì„¸ìš”', 'error'); return; }
  if (!url.includes('script.google.com') || !url.endsWith('/exec')) {
    showToast('âŒ URL í˜•ì‹ ì˜¤ë¥˜ â€” /exec ë¡œ ëë‚˜ì•¼ í•©ë‹ˆë‹¤', 'error');
    return;
  }
  window.open(url + '?test=1', '_blank');
}

function markConnected() {
  const url = document.getElementById('sheets-url').value.trim();
  if (!url) { showToast('â— URLì„ ë¨¼ì € ì…ë ¥í•´ì£¼ì„¸ìš”', 'error'); return; }
  sheetsUrl = url;
  localStorage.setItem('inv_sheets_url', sheetsUrl);
  updateStatus(true);
  showToast('âœ… ì—°ê²° ì„¤ì • ì™„ë£Œ! ì´ì œ ë°ì´í„°ë¥¼ ì „ì†¡í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤', 'success');
}

function saveSettings() {
  sheetsUrl = document.getElementById('sheets-url').value.trim();
  localStorage.setItem('inv_sheets_url', sheetsUrl);
  updateStatus(!!sheetsUrl);
}

function updateStatus(ok) {
  const dot = document.getElementById('status-dot');
  const txt = document.getElementById('status-text');
  if (ok && sheetsUrl) {
    dot.className = 'status-dot connected';
    txt.textContent = 'êµ¬ê¸€ ì‹œíŠ¸ ì—°ë™ í™œì„±í™”ë¨';
  } else {
    dot.className = 'status-dot';
    txt.textContent = 'URLì„ ì…ë ¥í•˜ë©´ ì—°ë™ì´ í™œì„±í™”ë©ë‹ˆë‹¤';
  }
}

function clearInput() {
  document.getElementById('msg-input').value = '';
  document.getElementById('result-box').classList.remove('show');
  currentParsed = null;
}

function copyScript() {
  const text = document.getElementById('script-code').textContent;
  navigator.clipboard.writeText(text).then(() => showToast('ğŸ“‹ ìŠ¤í¬ë¦½íŠ¸ ë³µì‚¬ë¨', 'success'));
}

// â”€â”€â”€ í† ìŠ¤íŠ¸ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showToast(msg, type = '') {
  const toast = document.getElementById('toast');
  toast.textContent = msg;
  toast.className = 'toast show ' + type;
  setTimeout(() => toast.className = 'toast', 2800);
}
</script>
</body>
</html>
